name: ğŸ“° Deploy VitePress site to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      repository_branches:
        description: 'YAML-MAP or JSON with repository branches: {"btp-manager":"main","istio":"release-1.20"} or [{"repository":"btp-manager","branch":"main"}]'
        required: false
        default: '{}'
  schedule:
    - cron: '0 0 * * *'  # Runs at 00:00 UTC every day

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  copy-docs:
    name: ğŸ“‹ Copy doc files from external repositories
    strategy:
      fail-fast: false
      matrix:
        repository:
          - btp-manager
          - istio
          - serverless
          - telemetry-manager
          - eventing-manager
          - api-gateway
          - nats-manager
          - application-connector-manager
          - keda-manager
          - cloud-manager
          - docker-registry
          - busola
          - cli
          - registry-proxy
          - community-modules
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”§ Determine branch for ${{matrix.repository}}
        id: get-branch
        run: |
          set -euo pipefail
          
          REPO="${{ matrix.repository }}"
          INPUT_RAW="${{ inputs.repository_branches }}"
          DEFAULT_BRANCH="main"
          BRANCH="$DEFAULT_BRANCH"
          
          echo "ğŸ“„ Raw input: $INPUT_RAW"
          echo "ğŸ” Repository: $REPO"
          echo "ğŸ” Default branch: $DEFAULT_BRANCH"
          
          # 1. Search in the env variables: build the variable name as repo name --> to capital --> replace " " and "-" with "_" --> append "_BRANCH"
          REPO_VAR=$(echo "$REPO" | tr '[:lower:]' '[:upper:]' | tr ' -' '_')_BRANCH
          echo "ğŸ” Computed env variable name: $REPO_VAR"
          
          # Variable expansion using ! is not working for env if VARIABLE is dynamic. Combine jq and toJson to get the env variable value
          VAR_BRANCH=$(jq -r --arg key "$REPO_VAR" '.[$key]' <<< '${{ toJson(vars) }}')

          echo "ğŸ” Value from env ($REPO_VAR): ${VAR_BRANCH:-<not set>}"
          
          if [ "$VAR_BRANCH" != "null" ]; then
            BRANCH="$VAR_BRANCH"
            echo "âœ… Using branch '$BRANCH' from GitHub variable ($REPO_VAR) for $REPO"
          else
            echo "â„¹ï¸ No GitHub variable found for $REPO, checking input YAML/JSON..."
          
            # 2. No GitHub variable, read from input string
            if [ -n "$INPUT_RAW" ] && [ "$INPUT_RAW" != "{}" ]; then
              echo "ğŸ” Parsing input..."
              if echo "$INPUT_RAW" | yq -o=json '.' >/dev/null 2>&1; then
                PARSED=$(echo "$INPUT_RAW" | yq -o=json '.')
                echo "âœ… Input read as YAML converted to JSON"
              elif echo "$INPUT_RAW" | jq empty >/dev/null 2>&1; then
                PARSED="$INPUT_RAW"
                echo "âœ… Valid JSON conversion"
              else
                echo "âš ï¸ Not a valid YAML nor JSON"
                PARSED="{}"
              fi
          
              echo "ğŸ” Parsed content: $PARSED"
          
              # 3. Search in the map {repo: branch}
              if echo "$PARSED" | jq -e "has(\"$REPO\")" >/dev/null 2>&1; then
                BRANCH=$(echo "$PARSED" | jq -r ".[\"$REPO\"]")
                echo "âœ… Found branch '$BRANCH' for $REPO (map format)"
              else
                # 4. Search as array [{repository: repo, branch: branch}]
                BRANCH_FROM_ARRAY=$(echo "$PARSED" | jq -r ".[] | select(.repository == \"$REPO\") | .branch" 2>/dev/null || echo "")
                echo "ğŸ” Branch from array: ${BRANCH_FROM_ARRAY:-<none>}"
                if [ -n "$BRANCH_FROM_ARRAY" ] && [ "$BRANCH_FROM_ARRAY" != "null" ]; then
                  BRANCH="$BRANCH_FROM_ARRAY"
                  echo "âœ… Found branch '$BRANCH' for $REPO (array format)"
                else
                  echo "â„¹ï¸ Repository $REPO not found in input, using default branch '$DEFAULT_BRANCH'"
                fi
              fi
            else
              echo "â„¹ï¸ No input provided, using default branch '$DEFAULT_BRANCH'"
            fi
          fi
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Final decision: Using branch '$BRANCH' for repository '$REPO'"

      - name: 'ğŸ—‚ï¸ Checkout ${{matrix.repository}} (branch: ${{steps.get-branch.outputs.branch}})'
        uses: actions/checkout@v4
        with:
          repository: kyma-project/${{matrix.repository}}
          ref: ${{steps.get-branch.outputs.branch}}
          path: ${{matrix.repository}}

      - name: ğŸš¢ Copy for main repo
        run: |
          SOURCE_PATH="${{matrix.repository}}/docs/user/"
          TARGET_PATH="./docs/external-content/${{matrix.repository}}/docs/"
          SOURCE_PATH_ASSETS="${{matrix.repository}}/docs/assets/"
          TARGET_PATH_ASSETS="./docs/external-content/${{matrix.repository}}/docs/"
          if [ -d "$SOURCE_PATH" ]; then
            echo "ğŸ“ found in ${{matrix.repository}}, copy to $TARGET_PATH"
            mkdir -p "$TARGET_PATH"
            cp -rf "$SOURCE_PATH/" "$TARGET_PATH/"
            if [ -d "$SOURCE_PATH_ASSETS" ]; then
              echo "â†³ğŸ“ found in ${{matrix.repository}}, copy to $TARGET_PATH_ASSETS"
              mkdir -p "$TARGET_PATH_ASSETS"
              cp -rf "$SOURCE_PATH_ASSETS/" "$TARGET_PATH_ASSETS/"
            else
              echo "â†³ğŸš« no folder  docs/assets in ${{matrix.repository}}"
            fi
          else
            echo "ğŸš« No folder docs/users in ${{matrix.repository}}"
          fi
      
      - name: ğŸ“¦ Upload copied docs
        uses: actions/upload-artifact@v5
        with:
          name: ${{matrix.repository}}
          path: ./docs/external-content/${{matrix.repository}}

  build-and-deploy:
    name: ğŸ› ï¸ Build and Deploy VitePress
    runs-on: ubuntu-latest
    needs: copy-docs
    steps:
      - name: ğŸ—‚ï¸ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download copied docs
        uses: actions/download-artifact@v5
        with:
          path: docs/external-content

      - name: ğŸª¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ’¾ Install dependencies
        run: npm install

      - name: ğŸ› ï¸ Build VitePress site
        run: npm run docs:build

      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸš€ Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist

      - name: ğŸ” Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‡³ Deploy to Netlify
        run: |
          npm install -g netlify-cli
          netlify deploy --prod \
            --dir=.vitepress/dist \
            --auth=$NETLIFY_AUTH_TOKEN \
            --site=$NETLIFY_SITE_ID
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
