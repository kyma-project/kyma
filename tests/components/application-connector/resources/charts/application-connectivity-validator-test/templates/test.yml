apiVersion: batch/v1
kind: Job
metadata:
  name: application-connectivity-validator-test
  namespace: {{ .Values.namespace }}
spec:
  backoffLimit: 0
  template:
    metadata:
      annotations:
        traffic.sidecar.istio.io/excludeOutboundPorts: "8080"
    spec:
      serviceAccountName: connectivity-validator-test
      initContainers:
        - name: wait-for-services
          image: opsfleet/depends-on
          args:
            - "-service=httpbin"
      containers:
        - name: application-connectivity-validator-test
          image: {{ include "imageurl" (dict "reg" .Values.containerRegistry "img" .Values.images.validatorTest) }}
          imagePullPolicy: Always
      restartPolicy: Never
---
apiVersion: v1
kind: ServiceAccount
metadata:
  creationTimestamp: null
  name: connectivity-validator-test
  namespace: test
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: test-service-role
  namespace: test
rules:
  - apiGroups:
      - ""
    resources:
      - services
      - pods
    verbs:
      - get
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  creationTimestamp: null
  name: test-service-rolebinding
  namespace: test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: test-service-role
subjects:
  - kind: ServiceAccount
    name: connectivity-validator-test
    namespace: test
