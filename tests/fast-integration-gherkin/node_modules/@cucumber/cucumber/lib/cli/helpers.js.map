{"version":3,"file":"helpers.js","sourceRoot":"","sources":["../../src/cli/helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import _ from 'lodash'\nimport ArgvParser from './argv_parser'\nimport ProfileLoader from './profile_loader'\nimport shuffle from 'knuth-shuffle-seeded'\nimport { EventEmitter } from 'events'\nimport PickleFilter from '../pickle_filter'\nimport { EventDataCollector } from '../formatter/helpers'\nimport { doesHaveValue } from '../value_checker'\nimport OptionSplitter from './option_splitter'\nimport { Readable } from 'stream'\nimport { IdGenerator } from '@cucumber/messages'\nimport * as messages from '@cucumber/messages'\nimport createMeta from '@cucumber/create-meta'\nimport { ISupportCodeLibrary } from '../support_code_library_builder/types'\nimport TestCaseHookDefinition from '../models/test_case_hook_definition'\nimport TestRunHookDefinition from '../models/test_run_hook_definition'\nimport { builtinParameterTypes } from '../support_code_library_builder'\n\nexport interface IGetExpandedArgvRequest {\n  argv: string[]\n  cwd: string\n}\n\nexport async function getExpandedArgv({\n  argv,\n  cwd,\n}: IGetExpandedArgvRequest): Promise<string[]> {\n  const { options } = ArgvParser.parse(argv)\n  let fullArgv = argv\n  const profileArgv = await new ProfileLoader(cwd).getArgv(options.profile)\n  if (profileArgv.length > 0) {\n    fullArgv = _.concat(argv.slice(0, 2), profileArgv, argv.slice(2))\n  }\n  return fullArgv\n}\n\ninterface IParseGherkinMessageStreamRequest {\n  cwd: string\n  eventBroadcaster: EventEmitter\n  eventDataCollector: EventDataCollector\n  gherkinMessageStream: Readable\n  order: string\n  pickleFilter: PickleFilter\n}\n\nexport async function parseGherkinMessageStream({\n  cwd,\n  eventBroadcaster,\n  eventDataCollector,\n  gherkinMessageStream,\n  order,\n  pickleFilter,\n}: IParseGherkinMessageStreamRequest): Promise<string[]> {\n  return await new Promise<string[]>((resolve, reject) => {\n    const result: string[] = []\n    gherkinMessageStream.on('data', (envelope: messages.Envelope) => {\n      eventBroadcaster.emit('envelope', envelope)\n      if (doesHaveValue(envelope.pickle)) {\n        const pickle = envelope.pickle\n        const pickleId = pickle.id\n        const gherkinDocument = eventDataCollector.getGherkinDocument(\n          pickle.uri\n        )\n        if (pickleFilter.matches({ gherkinDocument, pickle })) {\n          result.push(pickleId)\n        }\n      }\n      if (doesHaveValue(envelope.parseError)) {\n        reject(\n          new Error(\n            `Parse error in '${envelope.parseError.source.uri}': ${envelope.parseError.message}`\n          )\n        )\n      }\n    })\n    gherkinMessageStream.on('end', () => {\n      orderPickleIds(result, order)\n      resolve(result)\n    })\n    gherkinMessageStream.on('error', reject)\n  })\n}\n\n// Orders the pickleIds in place - morphs input\nexport function orderPickleIds(pickleIds: string[], order: string): void {\n  let [type, seed] = OptionSplitter.split(order)\n  switch (type) {\n    case 'defined':\n      break\n    case 'random':\n      if (seed === '') {\n        seed = Math.floor(Math.random() * 1000 * 1000).toString()\n        console.warn(`Random order using seed: ${seed}`)\n      }\n      shuffle(pickleIds, seed)\n      break\n    default:\n      throw new Error(\n        'Unrecgonized order type. Should be `defined` or `random`'\n      )\n  }\n}\n\nexport async function emitMetaMessage(\n  eventBroadcaster: EventEmitter\n): Promise<void> {\n  // eslint-disable-next-line @typescript-eslint/no-var-requires\n  const { version } = require('../../package.json')\n  eventBroadcaster.emit('envelope', {\n    meta: createMeta('cucumber-js', version, process.env),\n  })\n}\n\nfunction emitParameterTypes(\n  supportCodeLibrary: ISupportCodeLibrary,\n  eventBroadcaster: EventEmitter,\n  newId: IdGenerator.NewId\n): void {\n  for (const parameterType of supportCodeLibrary.parameterTypeRegistry\n    .parameterTypes) {\n    if (builtinParameterTypes.includes(parameterType.name)) {\n      continue\n    }\n    const envelope: messages.Envelope = {\n      parameterType: {\n        id: newId(),\n        name: parameterType.name,\n        preferForRegularExpressionMatch: parameterType.preferForRegexpMatch,\n        regularExpressions: parameterType.regexpStrings,\n        useForSnippets: parameterType.useForSnippets,\n      },\n    }\n    eventBroadcaster.emit('envelope', envelope)\n  }\n}\n\nfunction emitUndefinedParameterTypes(\n  supportCodeLibrary: ISupportCodeLibrary,\n  eventBroadcaster: EventEmitter\n): void {\n  for (const undefinedParameterType of supportCodeLibrary.undefinedParameterTypes) {\n    const envelope: messages.Envelope = {\n      undefinedParameterType,\n    }\n    eventBroadcaster.emit('envelope', envelope)\n  }\n}\n\nfunction emitStepDefinitions(\n  supportCodeLibrary: ISupportCodeLibrary,\n  eventBroadcaster: EventEmitter\n): void {\n  supportCodeLibrary.stepDefinitions.forEach((stepDefinition) => {\n    const envelope: messages.Envelope = {\n      stepDefinition: {\n        id: stepDefinition.id,\n        pattern: {\n          source: stepDefinition.pattern.toString(),\n          type:\n            typeof stepDefinition.pattern === 'string'\n              ? messages.StepDefinitionPatternType.CUCUMBER_EXPRESSION\n              : messages.StepDefinitionPatternType.REGULAR_EXPRESSION,\n        },\n        sourceReference: {\n          uri: stepDefinition.uri,\n          location: {\n            line: stepDefinition.line,\n          },\n        },\n      },\n    }\n    eventBroadcaster.emit('envelope', envelope)\n  })\n}\n\nfunction emitTestCaseHooks(\n  supportCodeLibrary: ISupportCodeLibrary,\n  eventBroadcaster: EventEmitter\n): void {\n  ;[]\n    .concat(\n      supportCodeLibrary.beforeTestCaseHookDefinitions,\n      supportCodeLibrary.afterTestCaseHookDefinitions\n    )\n    .forEach((testCaseHookDefinition: TestCaseHookDefinition) => {\n      const envelope: messages.Envelope = {\n        hook: {\n          id: testCaseHookDefinition.id,\n          tagExpression: testCaseHookDefinition.tagExpression,\n          sourceReference: {\n            uri: testCaseHookDefinition.uri,\n            location: {\n              line: testCaseHookDefinition.line,\n            },\n          },\n        },\n      }\n      eventBroadcaster.emit('envelope', envelope)\n    })\n}\n\nfunction emitTestRunHooks(\n  supportCodeLibrary: ISupportCodeLibrary,\n  eventBroadcaster: EventEmitter\n): void {\n  ;[]\n    .concat(\n      supportCodeLibrary.beforeTestRunHookDefinitions,\n      supportCodeLibrary.afterTestRunHookDefinitions\n    )\n    .forEach((testRunHookDefinition: TestRunHookDefinition) => {\n      const envelope: messages.Envelope = {\n        hook: {\n          id: testRunHookDefinition.id,\n          sourceReference: {\n            uri: testRunHookDefinition.uri,\n            location: {\n              line: testRunHookDefinition.line,\n            },\n          },\n        },\n      }\n      eventBroadcaster.emit('envelope', envelope)\n    })\n}\n\nexport function emitSupportCodeMessages({\n  eventBroadcaster,\n  supportCodeLibrary,\n  newId,\n}: {\n  eventBroadcaster: EventEmitter\n  supportCodeLibrary: ISupportCodeLibrary\n  newId: IdGenerator.NewId\n}): void {\n  emitParameterTypes(supportCodeLibrary, eventBroadcaster, newId)\n  emitUndefinedParameterTypes(supportCodeLibrary, eventBroadcaster)\n  emitStepDefinitions(supportCodeLibrary, eventBroadcaster)\n  emitTestCaseHooks(supportCodeLibrary, eventBroadcaster)\n  emitTestRunHooks(supportCodeLibrary, eventBroadcaster)\n}\n"]}