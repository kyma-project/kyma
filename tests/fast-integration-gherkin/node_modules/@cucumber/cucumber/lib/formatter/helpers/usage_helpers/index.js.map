{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/formatter/helpers/usage_helpers/index.ts"],"names":[],"mappings":"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","sourcesContent":["import _ from 'lodash'\nimport { getPickleStepMap } from '../pickle_parser'\nimport { getGherkinStepMap } from '../gherkin_document_parser'\nimport * as messages from '@cucumber/messages'\nimport StepDefinition from '../../../models/step_definition'\nimport { doesHaveValue } from '../../../value_checker'\nimport EventDataCollector from '../event_data_collector'\n\nexport interface IUsageMatch {\n  duration?: messages.Duration\n  line: number\n  text: string\n  uri: string\n}\n\nexport interface IUsage {\n  code: string\n  line: number\n  matches: IUsageMatch[]\n  meanDuration?: messages.Duration\n  pattern: string\n  patternType: string\n  uri: string\n}\n\nexport interface IGetUsageRequest {\n  cwd: string\n  eventDataCollector: EventDataCollector\n  stepDefinitions: StepDefinition[]\n}\n\nfunction buildEmptyMapping(\n  stepDefinitions: StepDefinition[]\n): Record<string, IUsage> {\n  const mapping: Record<string, IUsage> = {}\n  stepDefinitions.forEach((stepDefinition) => {\n    mapping[stepDefinition.id] = {\n      code: stepDefinition.unwrappedCode.toString(),\n      line: stepDefinition.line,\n      pattern: stepDefinition.expression.source,\n      patternType: stepDefinition.expression.constructor.name,\n      matches: [],\n      uri: stepDefinition.uri,\n    }\n  })\n  return mapping\n}\n\nconst unexecutedStatuses: readonly messages.TestStepResultStatus[] = [\n  messages.TestStepResultStatus.AMBIGUOUS,\n  messages.TestStepResultStatus.SKIPPED,\n  messages.TestStepResultStatus.UNDEFINED,\n]\n\nfunction buildMapping({\n  cwd,\n  stepDefinitions,\n  eventDataCollector,\n}: IGetUsageRequest): Record<string, IUsage> {\n  const mapping = buildEmptyMapping(stepDefinitions)\n  _.each(eventDataCollector.getTestCaseAttempts(), (testCaseAttempt) => {\n    const pickleStepMap = getPickleStepMap(testCaseAttempt.pickle)\n    const gherkinStepMap = getGherkinStepMap(testCaseAttempt.gherkinDocument)\n    testCaseAttempt.testCase.testSteps.forEach((testStep) => {\n      if (\n        doesHaveValue(testStep.pickleStepId) &&\n        testStep.stepDefinitionIds.length === 1\n      ) {\n        const stepDefinitionId = testStep.stepDefinitionIds[0]\n        const pickleStep = pickleStepMap[testStep.pickleStepId]\n        const gherkinStep = gherkinStepMap[pickleStep.astNodeIds[0]]\n        const match: IUsageMatch = {\n          line: gherkinStep.location.line,\n          text: pickleStep.text,\n          uri: testCaseAttempt.pickle.uri,\n        }\n        const { duration, status } = testCaseAttempt.stepResults[testStep.id]\n        if (!unexecutedStatuses.includes(status) && doesHaveValue(duration)) {\n          match.duration = duration\n        }\n        if (doesHaveValue(mapping[stepDefinitionId])) {\n          mapping[stepDefinitionId].matches.push(match)\n        }\n      }\n    })\n  })\n  return mapping\n}\n\nfunction invertDuration(duration: messages.Duration): number {\n  if (doesHaveValue(duration)) {\n    return -1 * messages.TimeConversion.durationToMilliseconds(duration)\n  }\n  return 1\n}\n\nfunction buildResult(mapping: Record<string, IUsage>): IUsage[] {\n  return _.chain(mapping)\n    .map(({ matches, ...rest }: IUsage) => {\n      const sortedMatches = _.sortBy(matches, [\n        (match: IUsageMatch) => invertDuration(match.duration),\n        'text',\n      ])\n      const result = { matches: sortedMatches, ...rest }\n      const durations: messages.Duration[] = _.chain(matches)\n        .map((m: IUsageMatch) => m.duration)\n        .compact()\n        .value()\n      if (durations.length > 0) {\n        result.meanDuration = messages.TimeConversion.millisecondsToDuration(\n          _.meanBy(durations, (d: messages.Duration) =>\n            messages.TimeConversion.durationToMilliseconds(d)\n          )\n        )\n      }\n      return result\n    })\n    .sortBy((usage: IUsage) => invertDuration(usage.meanDuration))\n    .value()\n}\n\nexport function getUsage({\n  cwd,\n  stepDefinitions,\n  eventDataCollector,\n}: IGetUsageRequest): IUsage[] {\n  const mapping = buildMapping({ cwd, stepDefinitions, eventDataCollector })\n  return buildResult(mapping)\n}\n"]}