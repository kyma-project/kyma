# Knative Eventing Mesh Migration Guide

Knative Eventing Mesh is a new feature in Kyma purely based on Knative and is soon to replaces Kyma Event Bus 

Knative Eventing Mesh allows you to easily integrate external applications with Kyma. Under the hood, the Eventing Mesh implements [Knative Eventing](https://knative.dev/docs/eventing/) to ensure Kyma receives business events from external sources and can trigger business flows using lambda functions or services. 

Eventing mesh Documentation [Knative Eventing Mesh Overview](https://kyma-project.io/docs/master/components/knative-eventing-mesh/#overview-overview) 

In order to migrate to the new Eventing mesh, you must upgrade Kyma from version 1.10 to version 1.11. Please follow the Kyma upgrade guide [Upgrade Kyma Guide](https://kyma-project.io/docs/#installation-upgrade-kyma)

## What's expected after update
* Objects conversion

    Some objects like Kyma subscriptions will be converted to Knative Triggers  
    To get list of triggers, run:
    ```bash
    ❯ kubectl -n test get triggers 
    
    NAME                                   READY   REASON   BROKER    SUBSCRIBER_URI             AGE 
    
    35c69d5b-66c6-5bb7-9016-7a46503602a1   True             default   http://lambda.test:8080/   6d7h 
    ```
* Kyma-integration namespace and user namespaces are ready for Eventing Mesh
* Caution: Events sent during the migration can be lost.

## Verification Steps
### Verify kyma-integration namespace is ready
* To list all the applications, run:
    ```bash
    ❯ kubectl get applications 
    
    NAME     AGE 
    
    commerce 6d4h
    ```
* Each application should have a corresponding HTTP-Source-Adapter, which is an HTTP server deployed inside the kyma-integration Namespace. This adapter acts as a gateway to the Channel and is responsible for exposing an endpoint to which the Application sends the events.
    ```bash
    ❯ kubectl -n kyma-integration get pods 
    ...
    commerce-5kbn2-deployment-78c4648497-x2hn6        3/3     Running     0          6d6h 
    ...
    ```
* Channel status should be READY
* FAQ
    * If any of the conditions above was not fulfilled, please try to recreate the application from Kyma console
    * If the problem still exists, please create a support ticket

### Verify the user namespaces are ready
* Per user namespace, if you added a service from Events Service Class, you should find a service instance in the user namespace

    To list the service instances in a namespace, run:
    ```bash
    ❯ kubectl -n test get serviceinstances.servicecatalog.k8s.io 
  
    NAME                                              CLASS                                          PLAN      STATUS   AGE 
  
    sap-commerce-cloud-events-4aef2-confused-editor   ServiceClass/sap-commerce-cloud-events-4aef2   default   Ready    6d10
    ```
* In the new Eventing Mesh, you should find a Broker per user namespace

    To list the brokers in a namespace, run:
    ```bash
    ❯ kubectl -n test get brokers 
    
    NAME      READY   REASON   URL                                            AGE 
    
    default   True             http://default-broker.test.svc.cluster.local   6d10h 
    ```
* Verify the Knative Subscription in kyma-integration namespace from application Knative channel to the Knative Broker exist

    ```bash
    ❯ kubectl -n kyma-integration get subscriptions.messaging.knative.dev 
    
    NAME              READY     REASON                   AGE 
    
    brokersub-skqcq   True       6d10h 
    ```
* Verify that the subscriber URI in the Knative Subscription is set to the broker
    ```bash
    ❯ kubectl -n kyma-integration get subscriptions.messaging.knative.dev brokersub-skqcq -o jsonpath='{ .spec.subscriber.uri }' 
    
    http://default-broker.test
    ```
* FAQ
    * If any of the conditions above was not fulfilled, please try to recreate the delete the service instance and recreate it again from the Kyma console
    * If the problem still exists, please create a support ticket
    
### Make sure the compatibility layer is working well
* Verify that sending events to the legacy endpoint https://gateway.domain/commerce/v1/events using app connector still consumed by the subscribed lambda
* P.S. It’s advised to use the new Knative Eventing Mesh endpoint https://gateway.domain/commerce/events/events