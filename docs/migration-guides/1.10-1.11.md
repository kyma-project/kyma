# Migrate from v1.10 to v1.11

## Kyma upgrade

Kyma release 1.11 introduces changes to the upgrade procedure. 

>**NOTE**: Following the upgrade instruction is enough to start working with Kyma version 1.11. You do not need to perform steps listed in [this](https://kyma-project.io/docs/root/kyma/#installation-upgrade-kyma-upgrade-kyma-to-a-newer-version) document.

To upgrade Kyma to version 1.11, follow these steps:

1. Delete the existing `kyma-installer` deployment.

```bash
kubectl delete deployment kyma-installer -n kyma-installer
```
2. Once the deployment is deleted, upgrade Tiller:

```bash
kubectl apply -f https://raw.githubusercontent.com/kyma-project/kyma/{NEW_KYMA_VERSION}/installation/resources/tiller.yaml
```
3. Verify that Tiller is running:

```bash
kubectl get po -n kube-system -l name=tiller -w
```

4. Apply the release file to the cluster to trigger the upgrade:
```bash
kubectl apply -f {KYMA-INSTALLER-CLUSTER-FILE}
```

5. To watch the upgrade process, run:

```bash
while true; do \
kubectl -n default get installation/kyma-installation -o jsonpath="{'Status: '}{.status.state}{', description: '}{.status.description}"; echo; \
sleep 5; \
done
```

## Clusters provisioned on Gardener

Starting from release 1.11, Gardener issues certificates required for cluster provisioning. Before 1.11, the approach was not unified, and `apiserver-proxy` had certificates issued under the xip.io domain with a self-signed certificate. We unified this behavior to allow Gardener manage all certificates. We have also modified TLS certificate handling to allow Kyma components react on the TLS rotation Gardener provides. 
Bear in mind that the domain you request the certificate for is subject to character restritions. This means that if the domain name you provide in the override exceeds 54 characters, applying an override to the cluster will result in the following error:

```bash
Step error:  Details: Helm install error: rpc error: code = Unknown desc = Job failed: BackoffLimitExceeded
```
This happens because the certificate issued for `apiserver-proxy` follows the `apiserver.$DOMAIN` naming convention, and this entire string cannot exceed 64 characters. 
For example, the `abcdefghij.myproject1.shoot.canary.k8s-hana.ondemand.com` domain name has 56 characters which together with the `apiserver` prefix is 65 characters.
To avoid any potential issues with the upgrade, make sure that the domain provided in the override does not exceed 54 characters. Run:

```bash
kubectl get cm -n kyma-installer net-global-overrides -o jsonpath="{.data['global\.\domainName']}" | wc -c
```
If the output value exceeds 54 characters, the installation of `apiserver-proxy` will fail. In such a case, you must create a new cluster with shorter name.
For details on character restrictions, see [this](https://gardener.cloud/050-tutorials/content/howto/x509_certificates/#character-restrictions) document.

## CLI

In this release, we introduced changes to the Kyma installation process to avoid potential issues during the Kyma upgrade. We ensured compliance with the recent Kyma CLI version, but using older versions results in the following error displayed during Kyma installation:

```bash 
- Kyma Installer deployed 
X Configuring Helm 
Error: jobs.batch "helm-certs-job" not found 
``` 
To ensure error-free Kyma installation, [upgrade](https://github.com/kyma-project/cli#installation) the Kyma CLI to the latest version.

## Knative Eventing Mesh 

To use the new [Knative Eventing Mesh](https://kyma-project.io/docs/master/components/knative-eventing-mesh/#overview-overview), you must upgrade Kyma from version 1.10 to version 1.11. To do so, follow the [Kyma upgrade guide](https://kyma-project.io/docs/#installation-upgrade-kyma). 

**CAUTION**: Events sent during the migration can be lost.
    
### Verify migration

Perform the following steps to see if the migration process was successful.

1. List all the applications:

    ```bash
     kubectl get applications 
    ```  
2. Check if each Application has a corresponding HTTP Source Adapter. 

    ```bash
    kubectl -n kyma-integration get httpsource
    ```
3. Check if the Channel status is `READY`
    ```bash
    kubectl -n kyma-integration get channels
   ```
4. Check if Kyma Subscriptions have been converted to Knative Triggers:

    ```bash
    kubectl -n <YOUR_NAMESPACE> get triggers 
    ``` 
    **NOTE**: If any of the steps results in a failure, recreate the Application using the Kyma Console. If the           problem persists, create a support ticket.

5. If you added a service using an EventsServiceClass, check if the service instance is present in your Namespace:
    
    ```bash
    kubectl -n <YOUR_NAMESPACE> get serviceinstances.servicecatalog.k8s.io 
    ```
  
6. Check if a Broker exists in your Namespace:
    
    ```bash
    kubectl -n <YOUR_NAMESPACE> get brokers
    ```
7. Check of the Eventing Mesh is enabled for your Namespace:
    ```bash
    kubectl get ns -lknative-eventing-injection=enabled
    ```
    
8. Check if a Knative Subscription exists in the `kyma-integration` Namespace, linking the Knative Channel to the Knative        Broker: 

    ```bash
    kubectl -n kyma-integration get subscriptions.messaging.knative.dev 
    ```
9. Check if a subscriber URI in the Knative Subscription points to the Broker:

    ```bash
    kubectl -n kyma-integration get subscriptions.messaging.knative.dev -o jsonpath='{ .items[*].spec.subscriber.uri }' -lapplication-name 
    ```
    **NOTE**: If any of the steps results in a failure, delete the service instance and recreate it using the Kyma  Console. If the problem persists, create a support ticket.
    
### Eventing endpoints

After the migration, use the new Knative Eventing Mesh endpoint, `https://gateway.domain/APP_NAME/events`, to send events.

**NOTE**: The old endpoint, `https://gateway.domain/APP_NAME/v1/events`, will be handled by the compatibility layer which uses the new Eventing Mesh to route events from the old endpoints to the sinks.