# Migrate from v1.11 to v1.12

## API Gateway

Migration from Api to APIRule custom resources (CRs) is performed automatically by a job that runs during the Kyma upgrade. During this process, the [API Gateway Migrator tool](https://github.com/kyma-project/kyma/blob/master/components/api-gateway-migrator/README.md#api-gateway-migrator) translates the existing Api CRs to APIRule CRs and deletes the original resources.

Before starting the migration process, ensure that all Api resources have a status. To do so, fetch all Apis without the status:

```shell script
kubectl get apis --all-namespaces -o json | jq '.items | .[] | select(.status == null)'
```

Receiving no results means that you can perform the upgrade. If, however, you can see any Api resources in the output, recreate each Api using this script:

```shell script
# set variables
export API_NAME={INSERT_API_NAME_HERE}
export API_NAMESPACE={INSERT_API_NAMESPACE_HERE}
# remove dependent resources
kubectl delete virtualservice -n ${API_NAMESPACE} ${API_NAME}
kubectl delete policy -n ${API_NAMESPACE} ${API_NAME} --ignore-not-found
# recreate Api
kubectl get api -n ${API_NAMESPACE} ${API_NAME} -o yaml | kubectl replace --force -f -
```

Once the Apis are recreated check again if all of them have a status. The output should not include any Api resources.

>**CAUTION:** Migrating resources may result in a temporary downtime of the exposed service. 

During migration, it may turn out that some resource specifications are too complex or fail to meet all the migration requirements. In such a case the process skips them but doesn't break the way existing services are exposed. However, if you want to introduce further changes or remove the Api CR, your actions won't have any effect on how the service is exposed because it will still use the original configuration.  

>**NOTE:** If the migration process skipped the Api resources due to the invalid status or a blacklisted label, migration is not possible.

Here are the steps you need to follow to ensure your services are properly migrated:

1. [Verify the migration](https://github.com/kyma-project/kyma/blob/1.12/docs/api-gateway/03-04-migration.md#verify-the-automatic-migration). 
2. If you can still see any Api CRs in use, use the [manual migration](https://github.com/kyma-project/kyma/blob/1.12/docs/api-gateway/03-04-migration.md#manual-migration) guide to migrate them.

## Serverless

Lambdas (Functions) created in previous releases won't work anymore because their underlying component, Kubeless, was removed. Migration from the previous solution to the new one requires manual steps - because of the complexity of Kubeless configuration, it was not possible to migrate the functions automatically.

Follow these sections and steps to migrate your existing Kubeless-based Functions to the new KService-based ones.

>**TIP:** All examples in this guide provide references to the corresponding fields from the deprecated resources. For example, `source: {spec.function}` means that you must enter the value from the **spec.function** field of the deprecated Function in the **spec.source** field of the new Function:
> ```bash
> spec:
>   [...]
>   source: {spec.function}
> ```

### Migrate functions.kubeless.io to functions.serverless.kyma-project.io

1. Remove `kubeless.io/function` from the **metadata.finalizers** field. To do that, edit the deprecated Function:

    ```bash
    kubectl edit functions.kubeless.io {NAME} -n {NAMESPACE}
    ```

2. Copy the Function to this file for reference:

    ```bash
    kubectl get functions.kubeless.io {NAME} -n {NAMESPACE} -o yaml > function.yaml
    ```

3. Delete the Function from the cluster:

    ```bash
    kubectl delete functions.kubeless.io {NAME} -n {NAMESPACE} -o yaml > function.yaml
    ```

4. Create a new Function based on values from the deprecated Function:

    ```bash
    cat <<EOF | kubectl apply -f  -
    apiVersion: serverless.kyma-project.io/v1alpha1
    kind: Function
    metadata:
      name: {NAME}
      namespace: {NAMESPACE}
      labels: {metadata.labels}
    spec:
      minReplicas: {spec.horizontalPodAutoscaler.spec.minReplicas}
      maxReplicas: {spec.horizontalPodAutoscaler.spec.maxReplicas}
      env: {spec.deployment.spec.template.spec.containers.env}
      resources: {spec.deployment.spec.template.spec.containers.resources}
      source: {spec.function}
      deps: {spec.deps}
    EOF
    ```

    >**CAUTION:** Don't copy the **annotations** field.

5. Wait until the Function is running:

    ```bash
    kubectl get functions.serverless.kyma-project.io {NAME} -n {NAMESPACE}
    ```

### Migrate Triggers assigned to the deprecated Function

1. List all triggers:

    ```bash
    kubectl get triggers.eventing.knative.dev -l Function={NAME} -n {NAMESPACE}
    ```

2. Get the UUID of the new Function:

    ```bash
    kubectl get functions.serverless.kyma-project.io {NAME} -o jsonpath='{.metadata.uid}' -n {NAMESPACE}
    ```

3. Edit the Subscriber and add the Owner Reference.

    a. Edit the Trigger:

    ```bash
    kubectl edit triggers.eventing.knative.dev {TRIGGER_NAME} -n {NAMESPACE}
    ```

    b. Change the **subscriber** field to:

    ```yaml
    spec:
      subscriber:
        ref:
          apiVersion: serving.knative.dev/v1
          kind: Service
          name: {NAME}
          namespace: {NAMESPACE}
    ```

    c. Add the Owner Reference:

    ```yaml
    metadata:
      ownerReferences:
      - apiVersion: serving.knative.dev/v1
        kind: Service
        name: {NAME}
        uid: {FUNCTION_UUID}
    ```

4. Check if the Trigger is ready:

    ```bash
    kubectl get triggers.eventing.knative.dev {TRIGGER_NAME} -n {NAMESPACE}
    ```

### Migrate the APIRule that exposes the Function

1. Find the APIRule with the name starting from the Function name. To list all APIRules in a Namespaces, run this command:

    ```bash
    kubectl get apirules.gateway.kyma-project.io -n {NAMESPACE} | grep {NAME}-
    ```

    Check which API Rule points to the Service that has the same name as the Function (**spec.service.name** field).

2. Edit the **handler** and **service** fields in the API Rule:

    ```bash
    kubectl edit apirules.gateway.kyma-project.io {API_NAME} -n {NAMESPACE}
    ```

    If the value of **spec.rules.accessStrategies.handler** is `allow`, change it to `noop`. Change the value of the **spec.service.port** field to `80`.

### Migrate the ServiceBindingUsage that binds the Service to the Function

1. Check if the new Function is running:

    ```bash
    kubectl get functions.serverless.kyma-project.io {NAME} -n {NAMESPACE}
    ```

2. List ServiceBindingsUsages assigned to the deprecated Function:

    ```bash
    kubectl get servicebindingusages.servicecatalog.kyma-project.io -l Function={NAME} -n {NAMESPACE}
    ```

3. Copy the ServiceBindingUsage to this file:

    ```bash
    kubectl get servicebindingusages.servicecatalog.kyma-project.io {BINDING_NAME} -n {NAMESPACE} -o yaml > binding.yaml
    ```

4. Delete the deprecated ServiceBindingUsage:

    ```bash
    kubectl delete servicebindingusages.servicecatalog.kyma-project.io {BINDING_NAME} -n {NAMESPACE}
    ```

5. Create a new ServiceBindingUsage based on values from the deprecated one:

    ```bash
    cat <<EOF | kubectl create -f  -
    apiVersion: servicecatalog.kyma-project.io/v1alpha1
    kind: ServiceBindingUsage
    metadata:
      labels: {metadata.labels}
      generateName: {FUNCTION_NAME}-
      namespace: {NAMESPACE}
      ownerReferences: {metadata.ownerReferences}
    spec:
      parameters: {spec.parameters}
      reprocessRequest: {spec.reprocessRequest}
      serviceBindingRef: {spec.serviceBindingRef}
      usedBy:
        kind: knative-service
        name: {FUNCTION_NAME}
    EOF
    ```
