---
title: Call a registered external service from Kyma
---
<!-- TODO: Adjust to the new flow -->

This guide shows how to call a registered external service from Kyma using a simple Function.

## Prerequisites

- Client certificates generated for the connected Application
- Your [Application name exported](ac-01-create-application.md#prerequisites) as an environment variable
- Your cluster domain exported as an environment variable
  ```bash
  export CLUSTER_DOMAIN=local.kyma.dev
  ```

> **CAUTION:** On a local Kyma deployment, skip SSL certificate verification when making a `curl` call, by adding the `-k` flag to it. Alternatively, add the Kyma certificates to your local certificate storage on your machine using the `kyma import certs` command.

## Steps

1. Run this command to create Application CRD with a service definition.

   > **NOTE:** See the [tutorial](ac-03-register-manage-services.md) to learn how to register a service.

   ```json
   cat <<EOF | kubectl apply -f -
   apiVersion: applicationconnector.kyma-project.io/v1alpha1
   kind: Application
   metadata:
     name: $APP_NAME
   spec:
     skipVerify: false
     services:
     - id: $TARGET_API_UUID
       name: test
       displayName: "Test"
       description: "Your service"
       providerDisplayName: "Your organisation"
       entries:
       - targetUrl: http://httpbin.org/
         type: API
   EOF
   ```

2. Execute this command to build path for accessing your registered service:
  
   ```bash
   export GATEWAY_URL=http://central-application-gateway.kyma-system:8080/$APP_NAME/test
   ```
   
3. Create a Function that sends a request to the registered service with an additional path of `/uuid`. A successful response returns a UUID generated by `httpbin.org`. To create and register the Function in the desired Namespace, run:

   ```bash
   cat <<EOF | kubectl apply -f -
   apiVersion: serverless.kyma-project.io/v1alpha1
   kind: Function
   metadata:
     name: my-function
     namespace: $NAMESPACE
     labels:
       app: my-function
   spec:
     deps: |-
       {
           "name": "example-1",
           "version": "0.0.1",
           "dependencies": {
             "request": "^2.85.0"
           }
       }
     source: |-
       const request = require('request');
   
       module.exports = { main: function (event, context) {
           return new Promise((resolve, reject) => {
               const url = \`http://\${process.env.GATEWAY_URL}/uuid\`;
               const options = {
                   url: url,
               };
   
               sendReq(url, resolve, reject)
           })
       } }
   
       function sendReq(url, resolve, reject) {
           request.get(url, { json: true }, (error, response, body) => {
               if(error){
                   resolve(error);
               }
               resolve(response.body);
           })
       }
     env:
     - name: GATEWAY_URL
       value: $GATEWAY_URL
   EOF
   ```
   
4. To expose the Function outside the cluster, create an API Rule custom resource.

   ```bash
   cat <<EOF | kubectl apply -f -
   apiVersion: gateway.kyma-project.io/v1alpha1
   kind: APIRule
   metadata:
     name: my-function
     namespace: $NAMESPACE
     labels:
       function: my-function
   spec:
     gateway: kyma-system/kyma-gateway
     rules:
     - path: /.*
       accessStrategies:
       - config: {}
         handler: noop
       methods:
       - GET
     service:
       host: my-function.$CLUSTER_DOMAIN
       name: my-function
       port: 80
   EOF
   ```

5. To verify that everything was set up correctly, you can now call the Function through HTTPS:

      ```bash
      curl https://my-function.$CLUSTER_DOMAIN/ | jq .
      ```

   >**NOTE:** If the response is empty, wait for a few moments for the Function to get ready and call it again.

   A successful response returns a UUID generated by `httpbin.org`:
   
   ```json
   {
     "uuid": "d44cc373-b26e-4a36-9890-6418d131a285"
   }
   ```
