---
title: Service Programming Model
type: Details
---
# Service Programming Model

A microservice deployed in Kyma can be configured to receive events from the event bus. This is achieved by creating a [subscription custom resource](https://github.com/kyma-project/kyma/blob/master/resources/cluster-essentials/templates/eventing-subscription.crd.yaml). Refer to [consume events section](https://github.com/kyma-project/kyma/blob/master/docs/event-bus/docs/011-details-event-flow-requirements.md#consume-events) for various configuration options.

## Event Delivery

```ascii
                                Event
   +--------------+        +---------------------------+       +--------------+
   |              |        |     Headers (Metadata)    |       |              |
   |              +--------+---------------------------+------->              |
   |  Event Bus   |        |       Body (Payload)      |       | Microservice |
   |              |        +---------------------------+       |              |
   |              |                  HTTP/1.1                  |              |
   |              |                    POST                    |              |
   +--------------+                                            +--------------+
```

The event is delivered as an `HTTP POST` request. Event Metadata is a part of HTTP request Headers. Event Payload is the body of the request.

## Event Metadata

Following HTTP headers provide information about the event metadata.

|Header| details|
|------|--------|
| kyma-event-id | This is the business event's ID which has been delivered to the micro-service. e.g. `8365633f-53d1-4518-85e7-e5604839bca7` |
| kyma-event-time | This is the business event's time which has been delivered to the micro-service. e.g. `2018-11-02T22:08:41+00:00` |
| kyma-event-type | This is the business event's type which has been delivered to the micro-service. e.g. `order.created` |
| kyma-event-type-version | This is the business event's version which has been delivered to the micro-service. e.g. `v1` |
| kyma-source-environment | This is the business event's source environment which has been delivered to the micro-service. e.g. `ec-qa` |
| kyma-source-namespace | This is the business event's source namespace which has been delivered to the micro-service. e.g. `local.kyma.commerce` |
| kyma-source-type | This is the business event's source type which has been delivered to the micro-service. e.g. `commerce` |
| kyma-subscription | This is the subscription name which is defined in the subscription contract/CRD and this business event has been published to it's subscribers. e.g. `example-subscription` |
| kyma-topic | This is the topic name used internally by the kyma event bus to deliver the messages tp the subscribers via a message bus. e.g. `ec-qa.local\.kyma\.commerce.commerce.test-event-bus.v1` |
| x-b3-flags | This header is used by the Zipkin tracer in Envoy. The encode one or more options. For example, Debug is encoded as X-B3-Flags: 1. See more on zipkin tracing [here](https://github.com/openzipkin/b3-propagation). e.g. `0` |
| x-b3-parentspanid | This header is used by the Zipkin tracer in Envoy. The ParentSpanId is 64-bit in length and indicates the position of the parent operation in the trace tree. When the span is the root of the trace tree, the ParentSpanId is absent. See more on zipkin tracing [here](https://github.com/openzipkin/b3-propagation) e.g. `3f52e7d591bf74e8` |
| x-b3-sampled | This header is used by the Zipkin tracer in Envoy. When the Sampled flag is either not specified or set to 1, the span will be reported to the tracing system. Once Sampled is set to 0 or 1, the same value should be consistently sent downstream. See more on zipkin tracing [here](https://github.com/openzipkin/b3-propagation). e.g. `1` |
| x-b3-spanid | This header is used by the Zipkin tracer in Envoy. The SpanId is 64-bit in length and indicates the position of the current operation in the trace tree. The value should not be interpreted: it may or may not be derived from the value of the TraceId. See more on zipkin tracing [here](https://github.com/openzipkin/b3-propagation). e.g. `7350c92dc6fa825e` |
|x-b3-traceid | This header is used by the Zipkin tracer in Envoy. The TraceId is 64-bit in length and indicates the overall ID of the trace. Every span in a trace shares this ID. See more on zipkin tracing [here](https://github.com/openzipkin/b3-propagation). e.g. `02c04beed9aa6c53` |
| x-request-id | Randomly generated ID for identifies the HTTP request delivering the business event. e.g. `ec0ffa2a-13b6-9e63-9563-12e5c0e27e38` |
| x-envoy-decorator-operation | If this header is present on ingress requests, its value will override any locally defined operation (span) name on the server span generated by the tracing mechanism. Similarly, if this header is present on an egress response, its value will override any locally defined operation (span) name on the client span. e.g. `default-route` |
| x-envoy-expected-rq-timeout-ms | This is the time in milliseconds the router expects the request to be completed. Envoy sets this header so that the upstream host receiving the request can make decisions based on the request timeout, e.g., early exit. This is set on internal requests and is either taken from the `x-envoy-upstream-rq-timeout-ms` header or the route timeout, in that order. e.g. `15000` |
| x-istio-attributes | istio specific metadata. e.g. `CkMKCnNvdXJjZS51aWQSNRIza3ViZXJuZXRlczovL2NvcmUtcHVzaC01ZDg5OTU1ZjhiLXhjZ3ZyLmt5bWEtc3lzdGVtCh8KCXNvdXJjZS5pcBISMhAAAAAAAAAAAAAA//+sEQAb` |

## Event Payload

The event paylaod is delivered as the body of the HTTP Request in JSON format. The JSON schema is available in the Service Catalog in the registered service for the remote events.

# Event Paylod Example

For example, writing a service interested in an event `order.created` published by `ec` service. the published event is schema is something like:

```json
{
  "example": {
    "orderCode": "4caad296-e0c5-491e-98ac-0ed118f9474e"
  },
  "properties": {
    "orderCode": {
      "description": "Resource identifier",
      "title": "OrderCode",
      "type": "string"
    }
  },
  "type": "object"
}
```

So, the HTTP POST request payload would be a JSON object like:

```json
{"orderCode": "4caad296-e0c5-491e-98ac-0ed118f9474e"}
```

## Successful Delivery

The delivered message to a subscriber would be considered as successfully consumed if the service HTTP response status code was `2xx`. However, responding with a status code not a `2xx` (< 200 or >= 300) means an unsuccessful message consumption and the message delivery will be retried. And this implies **At-least-once** delivery guarantee.

## Event Subscription Service Example

Refer to his [example](https://github.com/kyma-project/examples/tree/master/event-subscription/service) to find a complete scenario for implementing a subscriber service to a business event.
