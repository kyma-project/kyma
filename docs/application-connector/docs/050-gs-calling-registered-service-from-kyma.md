---
title: Calling registered service from within Kyma
type: Getting Started
---

This guide shows how to call the registered service from within the Kyma using a simple lambda function.


## Prerequisites

- Remote Environment created and bound to the `production` Environment.
- Client certificates for the RE generated.


## Steps

1. Register a service with the following specyfication to the desierd Remote Envoronment:
```json
{
  "name": "my-service",
  "provider": "myCompany",
  "Identifier": "identifier",
  "description": "This is some service",
  "api": {
    "targetUrl": "http://httpbin.org/",
    "spec": {
      "swagger":"2.0"
    }
  }
}
```
Our service will call http://httpbin.org.
Save the received service id, as it is used in the later steps.

2. Next you need to create the Service Instance. To achive this you need the `externalName` of the Cluster Service Class.
To get the `externalName` run:
```
kubectl get clusterserviceclass {SERVICE_ID} -o jsonpath='{.spec.externalName}'
```

Use it to create the Service Instance
```
cat <<EOF | kubectl apply -f -
apiVersion: servicecatalog.k8s.io/v1beta1
kind: ServiceInstance
metadata:
  name: my-service-instance-name
  namespace: production
spec:
  clusterServiceClassExternalName: {EXTERNAL_NAME}
EOF
```

3. Create lambda that calls registered service
```
cat <<EOF | kubectl apply -f -
apiVersion: kubeless.io/v1beta1
kind: Function
metadata:
  name: my-lambda
  namespace: production
spec:
  deployment:
    spec:
      template:
        metadata:
          labels:
            re-{RE_NAME}-{SERVICE_ID}: "true"
        spec:
          containers:
          - env:
            - name: GATEWAY_URL
              value: re-{RE_NAME}-{SERVICE_ID}.kyma-integration
  deps: |-
    {
        "name": "example-1",
        "version": "0.0.1",
        "dependencies": {
          "request": "^2.85.0"
        }
    }
  function: |-
    const request = require('request');

    module.exports = { main: function (event, context) {
        return new Promise((resolve, reject) => {
            const url = \`http://\${process.env.GATEWAY_URL}/uuid\`;
            const options = {
                url: url,
            };
              
            sendReq(url, resolve, reject)
        })
    } }

    function sendReq(url, resolve, reject) {
        request.get(url, { json: true }, (error, response, body) => {
            if(error){
                resolve(error);
            }
            resolve(response.body);
        })
    }
  function-content-type: text
  handler: handler.main
  horizontalPodAutoscaler:
    spec:
      maxReplicas: 0
  runtime: nodejs8
  service:
    ports:
    - name: http-function-port
      port: 8080
      protocol: TCP
      targetPort: 8080
    selector:
      created-by: kubeless
      function: my-lambda
  timeout: ""
  topic: http
EOF
```
The lambda will call the service with additional path `/uuid`, therefor as a response we should 

4. Create Service Binding and Service Binding Usage to bind the previously create Service Instance to the lambda.

```
cat <<EOF | kubectl apply -f -
apiVersion: servicecatalog.k8s.io/v1beta1
kind: ServiceBinding
metadata:
  labels:
    Function: my-lambda
  name: my-service-binding
  namespace: production
spec:
  instanceRef:
    name: my-service-instance-name
EOF
```

```
cat <<EOF | kubectl apply -f -
apiVersion: servicecatalog.kyma.cx/v1alpha1
kind: ServiceBindingUsage
metadata:
  labels:
    Function: my-lambda
    ServiceBinding: my-service-binding
  name: my-service-binding
  namespace: production
spec:
  serviceBindingRef:
    name: my-service-binding
  usedBy:
    kind: function
    name: my-lambda
EOF
```

5. To expose lambda outside the cluster create a Api resource:
```
cat <<EOF | kubectl apply -f -
apiVersion: gateway.kyma.cx/v1alpha2
kind: Api
metadata:
  labels:
    function: my-lambda
  name: my-lambda
  namespace: production
spec:
  authentication: []
  hostname: my-lambda-production.{CLUSTER_DOMAIN}
  service:
    name: my-lambda
    port: 8080
EOF
```
On Minikube as a cluster domain use `kyma.local`.

6. To verify that everything was setup correctly you now can call the lambda through https:
```
curl https://my-lambda-production.{CLUSTER_DOMAIN}/ -k
```

On Minikube one additional step is required.
For you to be able to access the lambda over https you need to edit `/etc/hosts/` file and map `my-lambda-production.kyma.local` to the Minikube ip.

After that you can use `curl` to call the lambda:
```
curl https://my-lambda-production.kyma.local/ -k
```

As a response you should receive uuid generated by httpbin.org:
```json
{
    "uuid":"d44cc373-b26e-4a36-9890-6418d131a285"
}
```