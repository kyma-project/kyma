---
# Source: apiserver-proxy/templates/dashboard-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: apiserver-proxy-dashboard
  labels:
    grafana_dashboard: "1"
    app: monitoring-grafana
data:
  apiserver-proxy-dashboard.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": "-- Grafana --",
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": 55,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "datasource": null,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 10,
          "panels": [],
          "title": "Application metrics",
          "type": "row"
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 1
          },
          "hiddenSeries": false,
          "id": 6,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "go_goroutines{service=\"apiserver-proxy-metrics\"}",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Goroutines",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 1
          },
          "hiddenSeries": false,
          "id": 8,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "go_threads{service=\"apiserver-proxy-metrics\"}",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Go threads",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 9
          },
          "hiddenSeries": false,
          "id": 12,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "go_gc_duration_seconds{service=\"apiserver-proxy-metrics\"}",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "quantile: {{ quantile }} ({{ pod }}) ",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "GC invocations durations",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 9
          },
          "hiddenSeries": false,
          "id": 16,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "go_memstats_heap_inuse_bytes{job=\"apiserver-proxy-metrics\"}",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "Heap in use",
              "refId": "A"
            },
            {
              "expr": "go_memstats_stack_inuse_bytes{job=\"apiserver-proxy-metrics\"}",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "Stack in use",
              "refId": "B"
            },
            {
              "expr": "container_memory_usage_bytes{container_name=~\"auth-proxy|istio-proxy\", pod_name=~\"apiserver-proxy.*\"}",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "{{ container_name }} (k8s)",
              "refId": "C"
            },
            {
              "expr": "sum(container_memory_usage_bytes{container_name=~\"auth-proxy|istio-proxy\", pod_name=~\"apiserver-proxy.*\"})",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "Total",
              "refId": "D"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Memory",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "bytes",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "collapsed": false,
          "datasource": null,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 17
          },
          "id": 4,
          "panels": [],
          "title": "Network metrics",
          "type": "row"
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 18
          },
          "hiddenSeries": false,
          "id": 20,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{service=~\"apiserver-proxy.*\"}[5m])) by (job)",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "{{ job }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Req/s",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "reqps",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 18
          },
          "hiddenSeries": false,
          "id": 18,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "rate(http_requests_total{service=~\"apiserver-proxy-metrics.*\",status_code=~\"5.*\"}[5m]) / rate(http_requests_total[5m])\n\n",
              "format": "time_series",
              "intervalFactor": 1,
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "HTTP Error Rates (5xx)",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 26
          },
          "hiddenSeries": false,
          "id": 2,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "sum by (code) (rate(http_requests_total{service=\"apiserver-proxy.*\"}[5m]))",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "{{ code }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Request rate by status code",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "reqps",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 26
          },
          "hiddenSeries": false,
          "id": 14,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "links": [],
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "sort_desc(sum by (pod_name) (rate(container_network_receive_bytes_total{pod_name=~\"apiserver-proxy.*\"}[1m])))",
              "format": "time_series",
              "intervalFactor": 2,
              "legendFormat": "{{ pod_name }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Network I/O",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "bytes",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "collapsed": false,
          "datasource": null,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 34
          },
          "id": 30,
          "panels": [],
          "title": "Average request durations",
          "type": "row"
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 35
          },
          "hiddenSeries": false,
          "id": 22,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "rate(authentication_durations_sum[5m])/rate(authentication_durations_count[5m])",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Average authentication durations",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 35
          },
          "hiddenSeries": false,
          "id": 24,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "rate(spdy_negotiation_durations_sum[5m])/rate(spdy_negotiation_durations_count[5m])",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "SPDY average negotiation durations",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "collapsed": false,
          "datasource": null,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 43
          },
          "id": 40,
          "panels": [],
          "title": "Requests percentiles",
          "type": "row"
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 44
          },
          "hiddenSeries": false,
          "id": 41,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(authentication_durations_bucket[5m]))",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Authentication 95th percentile",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 44
          },
          "hiddenSeries": false,
          "id": 42,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "histogram_quantile(0.99, rate(authentication_durations_bucket[5m]))",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "Authentication 99th percentile",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 52
          },
          "hiddenSeries": false,
          "id": 45,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(spdy_negotiation_durations_bucket[5m]))",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "SPDY negotiation 95th percentile",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        },
        {
          "aliasColors": {},
          "bars": false,
          "dashLength": 10,
          "dashes": false,
          "datasource": "Prometheus",
          "fill": 1,
          "fillGradient": 0,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 52
          },
          "hiddenSeries": false,
          "id": 46,
          "legend": {
            "avg": false,
            "current": false,
            "max": false,
            "min": false,
            "show": true,
            "total": false,
            "values": false
          },
          "lines": true,
          "linewidth": 1,
          "nullPointMode": "null",
          "options": {
            "dataLinks": []
          },
          "paceLength": 10,
          "percentage": false,
          "pointradius": 2,
          "points": false,
          "renderer": "flot",
          "seriesOverrides": [],
          "spaceLength": 10,
          "stack": false,
          "steppedLine": false,
          "targets": [
            {
              "expr": "histogram_quantile(0.99, rate(spdy_negotiation_durations_bucket[5m]))",
              "format": "time_series",
              "intervalFactor": 1,
              "legendFormat": "{{ pod }}",
              "refId": "A"
            }
          ],
          "thresholds": [],
          "timeFrom": null,
          "timeRegions": [],
          "timeShift": null,
          "title": "SPDY negotiation 99th percentile",
          "tooltip": {
            "shared": true,
            "sort": 0,
            "value_type": "individual"
          },
          "type": "graph",
          "xaxis": {
            "buckets": null,
            "mode": "time",
            "name": null,
            "show": true,
            "values": []
          },
          "yaxes": [
            {
              "format": "s",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            },
            {
              "format": "short",
              "label": null,
              "logBase": 1,
              "max": null,
              "min": null,
              "show": true
            }
          ],
          "yaxis": {
            "align": false,
            "alignLevel": null
          }
        }
      ],
      "schemaVersion": 21,
      "style": "dark",
      "tags": [
        "kubernetes",
        "kyma"
      ],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-6h",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": [
          "5s",
          "10s",
          "30s",
          "1m",
          "5m",
          "15m",
          "30m",
          "1h",
          "2h",
          "1d"
        ],
        "time_options": [
          "5m",
          "15m",
          "1h",
          "6h",
          "12h",
          "24h",
          "2d",
          "7d",
          "30d"
        ]
      },
      "timezone": "",
      "title": "Kyma / Core / API Server Proxy tmp",
      "uid": "sdfsdfsdf",
      "version": 2
    }

---
# Source: apiserver-proxy/templates/job.yaml

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sss-ssl-helper-service-account
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    "helm.sh/hook": "post-install, post-upgrade"
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: sss-ssl-helper-role
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    "helm.sh/hook": "post-install, post-upgrade"
rules:
  - apiGroups: [""]
    resources: ["services"]
    resourceNames: ['sss-ssl']
    verbs: ["get", "patch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: sss-ssl-helper-role-binding
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    "helm.sh/hook": "post-install, post-upgrade"
subjects:
  - kind: ServiceAccount
    name: sss-ssl-helper-service-account
    namespace: default
roleRef:
  kind: Role
  name: sss-ssl-helper-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook-delete-policy: "hook-succeeded,before-hook-creation"
    "helm.sh/hook": "post-install, post-upgrade"
    helm.sh/hook-weight: "1"
  name: sss-ssl-helper-job
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
        -
          command:
            - /bin/bash
            - -c
            - |
              set +e
              retry=0

              while [[ ${retry} -lt 5 ]]; do
                result=$(kubectl -n kyma-system annotate service sss-ssl dns.gardener.cloud/class='garden' dns.gardener.cloud/dnsnames='apiserver.'kyma.local'' --overwrite)
                err=$?
                if [[ ${err} -eq 0 ]]; then
                  echo "${result}"
                  exit 0
                fi
                sleep 5
                (( retry++ ))
              done
              echo "Maximum retries exceeded"
              exit 1
          image: eu.gcr.io/kyma-project/test-infra/alpine-kubectl:v20200310-5f52f407
          name: gardener-annotate
      restartPolicy: Never
      serviceAccountName: sss-ssl-helper-service-account

---
# Source: apiserver-proxy/templates/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sss
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sss
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: sss
  namespace: default

---
# Source: apiserver-proxy/charts/apiserver-proxy-init/templates/service-ssl.yaml
apiVersion: v1
kind: Service
metadata:
  name: apiserver-proxy-ssl
  namespace: default
spec:
  
  type: LoadBalancer
  
  ports:
  - name: https
    port: 443
    protocol: TCP
    targetPort: 9443
  selector:
    app: apiserver-proxy

---
# Source: apiserver-proxy/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
  name: sss
  namespace: default
spec:
  ports:
  - name: http
    port: 8444
    protocol: TCP
    targetPort: 8444
  selector:
    app: sss
---
# Dedicated Service for metrics endpoint
apiVersion: v1
kind: Service
metadata:
  name: sss-metrics
  labels:
    app: sss
    chart: "apiserver-proxy-0.0.1"
    release: "release-name"
    heritage: "Tiller"
spec:
  ports:
    - name: http-metrics
      port: 2112
  selector:
    app: sss

---
# Source: apiserver-proxy/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sss
  namespace: default
spec:
  selector:
    matchLabels:
      app: sss
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1  
      maxSurge: 1
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "true"
        traffic.sidecar.istio.io/excludeInboundPorts: "8443"
        prometheus.io/port: "2112"
        prometheus.io/path: "/"
        prometheus.io/scrape: "true"
      labels:
        app: sss
        tlsSecret: ingress-tls-cert
    spec:
      serviceAccountName: sss
      
      containers:
      - image: ddd/sssapiserver-proxy:3b88aaaf
        name: auth-proxy
        
        resources:
          limits:
            memory: 256Mi
          requests:
            memory: 96Mi
        
        imagePullPolicy: IfNotPresent
        args:
        - --insecure-listen-address=0.0.0.0:8444
        - --secure-listen-address=0.0.0.0:9443
        - --tls-cert-file=/etc/tls-cert/tls.crt
        - --tls-private-key-file=/etc/tls-cert/tls.key
        - --upstream=https://kubernetes.default
        - --logtostderr=true
        - --v=10
        - --oidc-issuer=https://dex.dd
        - --oidc-clientID=kyma-client
        
        - --cors-allow-origin=*
        - --cors-allow-headers=authorization,content-type
        - --cors-allow-methods=GET,POST,PUT,DELETE
        - --metrics-listen-address=0.0.0.0:2112
        ports:
        - containerPort: 8444
          name: insecure
        - containerPort: 2112
          name: metrics
        - containerPort: 9443
          name: secure
          
        volumeMounts:
        - name: tls-cert
          mountPath: /etc/tls-cert/
      
      volumes:
      
      - name: tls-cert
        secret:
          secretName: sss-tls-cert

---
# Source: apiserver-proxy/templates/autoscale.yaml

---
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: sss
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sss
  minReplicas: 1
  maxReplicas: 3
  metrics:
  - resource:
      name: memory
      targetAverageUtilization: 50
    type: Resource


---
# Source: apiserver-proxy/charts/apiserver-proxy-init/templates/generate-certs-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: apiserver-proxy-certs-job
  annotations:
    helm.sh/hook-weight: "5"
    helm.sh/hook: "post-install,post-upgrade"
    helm.sh/hook-delete-policy: "before-hook-creation"
spec:
  backoffLimit: 1
  template:
    metadata:
      name: apiserver-proxy-certs-job
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: apiserver-proxy-certs-job
      restartPolicy: Never
      volumes:
        - name: apiserver-proxy-tls-cert
          secret:
            secretName: apiserver-proxy-tls-cert
            optional: true
      containers:
      - name: generate-certs
        image: ddd/sssxip-patch:0e322dac
        envFrom:
        - configMapRef:
            name: apiserver-proxy
            optional: true
        command:
        - bash
        - -c
        - |
            #!/usr/bin/env bash
            set -e
            # if running on Gardener create Certificate CR
            # else proceed 'old' way
            
            
            cat <<EOF | kubectl apply -f -
            apiVersion: cert.gardener.cloud/v1alpha1
            kind: Certificate
            metadata:
              name: apiserver-proxy-tls-cert
              namespace: kyma-system
            spec:
              commonName: "apiserver.kyma.local"
              secretName: "apiserver-proxy-tls-cert"
            EOF
            
              SECONDS=0
              END_TIME=$((SECONDS+600)) #600 seconds = 10 minutes
              while [ ${SECONDS} -lt ${END_TIME} ];do
                STATUS="$(kubectl get -n default certificate.cert.gardener.cloud apiserver-proxy-tls-cert -o jsonpath='{.status.state}')"
                if [ "${STATUS}" = "Ready" ]; then
                  break
                fi
                echo "Waiting for Certicate generation, status is ${STATUS}"
                sleep 10
              done
              if [ "${STATUS}" != "Ready" ]; then
                echo "Certificate is still not ready, status is ${STATUS}. Exiting.."
                exit 1
              fi
              DOMAIN="kyma.local"
            
            
              kubectl create configmap apiserver-proxy --from-literal DOMAIN="$DOMAIN"
            if [ "$(cat /etc/apiserver-proxy-tls-cert/tls.key)" = "" ]; then
            # if running on Gardener && there is key mouted we skip, do nothing
            # if running on given by user domain create secret with key and cert
            # else generate domain and create secret
            
              echo "Skipping processing existing cert because environment is Gardener which rotates certs by itself"
            
            fi
        volumeMounts:
        - name: apiserver-proxy-tls-cert
          mountPath: /etc/apiserver-proxy-tls-cert/
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apiserver-proxy-certs-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apiserver-proxy-certs-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apiserver-proxy-certs-job
subjects:
- kind: ServiceAccount
  name: apiserver-proxy-certs-job
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: apiserver-proxy-certs-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
rules:
- apiGroups: [""]
  resources: [secrets, services]
  verbs: [create, list, get, watch]
- apiGroups: [""]
  resources: [configmaps]
  verbs: [create, list, get, watch, update ]
---

kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: kube-system
  name: apiserver-proxy-certs-job-kube-system-role
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["shoot-info"]
  verbs: ["get"]
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: apiserver-proxy-certs-job-gardener-certs-role
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
rules:
- apiGroups: ["cert.gardener.cloud"]
  resources: ["certificates"]
  verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apiserver-proxy-certs-job-gardener-certs-role
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apiserver-proxy-certs-job-gardener-certs-role
subjects:
- kind: ServiceAccount
  name: apiserver-proxy-certs-job
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apiserver-proxy-certs-job-kube-system-role
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "post-install, post-upgrade"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apiserver-proxy-certs-job-kube-system-role
subjects:
- kind: ServiceAccount
  name: apiserver-proxy-certs-job
  namespace: default

---
# Source: apiserver-proxy/charts/apiserver-proxy-init/templates/upgrade-job.yaml


apiVersion: batch/v1
kind: Job
metadata:
  name: apiserver-proxy-upgrade-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "5"
    helm.sh/hook: "pre-install"
    helm.sh/hook-delete-policy: "before-hook-creation"
spec:
  backoffLimit: 1
  template:
    metadata:
      name: apiserver-proxy-upgrade-job
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: apiserver-proxy-upgrade-job
      restartPolicy: Never
      containers:
      - name: wait-for-deletion
        image: eu.gcr.io/kyma-project/test-infra/alpine-kubectl:v20200310-5f52f407
        command:
        - bash
        - -c
        - |
          set +e
          retry=0
          while [[ ${retry} -lt 5 ]]; do
            if ! kubectl get service -n kyma-system apiserver-proxy-ssl > /dev/null; then
                echo "Service has been deleted. Proceeding..."
                exit 0
            fi
            echo "Service apiserver-proxy-ssl has not been deleted. Sleeping..."
            sleep 5
            (( retry++ ))
          done
          echo "Timeout waiting for service apiserver-proxy-ssl deletion. Exiting..."
          exit 1
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apiserver-proxy-upgrade-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "pre-install"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: apiserver-proxy-upgrade-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "pre-install"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: apiserver-proxy-upgrade-job
subjects:
- kind: ServiceAccount
  name: apiserver-proxy-upgrade-job
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: apiserver-proxy-upgrade-job
  namespace: default
  annotations:
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
    helm.sh/hook: "pre-install"
rules:
- apiGroups: [""]
  resources: [services]
  verbs: [list, get, watch]

---
# Source: apiserver-proxy/templates/policy.yaml
---
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: sss-ssl
  namespace: default
spec:
  peers:
    - mtls:
        mode: PERMISSIVE
  targets:
    - name: sss-ssl
---
# Disable MTLS for the metrics service
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: sss-metrics
spec:
  peers:
  - mtls:
      mode: PERMISSIVE
  targets:
  - name: sss-metrics
---
# Source: apiserver-proxy/templates/servicemonitor.yaml
# Inform Prometheus to scrap the metrics endpoint
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: release-name-apiserver-proxy
  labels:
    prometheus: monitoring
    app: sss
    chart: "apiserver-proxy-0.0.1"
    release: "release-name"
    heritage: "Tiller"
spec:
  endpoints:
    - port: http-metrics
      path: /
      metricRelabeligs:
      - sourceLabels: [ __name__ ]
        regex: ^(apiserver_client_certificate_expiration_seconds_bucket|authentication_durations_bucket|authentication_durations_count|authorization_durations_bucket|authorization_durations_count|go_gc_duration_seconds|go_goroutines|go_memstats_alloc_bytes|go_memstats_heap_alloc_bytes|go_memstats_heap_inuse_bytes|go_memstats_heap_sys_bytes|go_memstats_stack_inuse_bytes|go_threads|http_requests_total|process_cpu_seconds_total|process_max_fds|process_open_fds|process_resident_memory_bytes|process_start_time_seconds|process_virtual_memory_bytes|spdy_negotiation_durations_bucket|spdy_negotiation_durations_count)$
        action: keep
  namespaceSelector:
    matchNames:
      - "default"
  selector:
    matchLabels:
      app: sss

---
# Source: apiserver-proxy/templates/tests/test.yaml
---

---
# Source: apiserver-proxy/templates/virtual-service.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sss
  namespace: default
spec:
  hosts:
  - "apiserver.dd"
  gateways:
  - dd
  http:
  - match:
    - uri:
        regex: /.*
    route:
    - destination:
        port:
          number: 8444
        host: sss
    corsPolicy:
      allowHeaders:
      - authorization
      - content-type
      allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      allowOrigin:
      - '*'
      
