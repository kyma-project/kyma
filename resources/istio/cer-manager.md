# Cert Manager POC

## Registering Issuer

```
cat <<EOF | kubectl apply -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Issuer
metadata:
 name: letsencrypt-staging
 namespace: istio-system
spec:
 acme:
   email: kyma@kyma-project.com
   server: https://acme-staging-v02.api.letsencrypt.org/directory
   privateKeySecretRef:
     # Secret resource used to store the account's private key.
     name: kyma-issuer-account-key
   http01: {}
---
EOF
 ```
 
 Note Issuer is configured with http challenge not DNS challenge.
 
 Next check registered issuer ```kubectl describe issuer -n istio-system```
 
 It should has status like this :
 
 ```
  Acme:
    Uri:  https://acme-staging-v02.api.letsencrypt.org/acme/acct/10534352
  Conditions:
    Last Transition Time:  2019-08-12T12:14:36Z
    Message:               The ACME account was registered with the ACME server
    Reason:                ACMEAccountRegistered
    Status:                True
    Type:                  Ready
```
 
## Create gateway listening on port 80

```
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-autogenerated-k8s-ingress
  namespace: istio-system
  labels:
    app: ingressgateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      protocol: HTTP2
      name: http
    hosts:
    - "*"
EOF
```

## Issue a certificate for sample service

```
cat <<EOF | kubectl apply -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: hello-certificate
  namespace: istio-system
spec:
  secretName: hello-certificate
  issuerRef:
    name: letsencrypt-staging  
  dnsNames:
  - 'hello.$DOMAIN'  
  acme:
    config:
    - http01:
        ingressClass: istio
      domains:
      - 'hello.$DOMAIN'  
EOF
```

Note that you need to replace $DOMAIN 


Check after a while the certificate

```kubectl describe certificate -n istio-system```


## Create gateway for hello service

``` 
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: hello-gateway
  namespace: istio-system
  labels:
    app: ingressgateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      protocol: HTTPS
      name: https-default
    tls:
      mode: SIMPLE
      serverCertificate: "sds"
      privateKey: "sds"
      credentialName: "hello-certificate"
    hosts:
    - "hello.34.76.10.230.xip.io"
---
EOF
```


## Deploy hello svc

```
 kubectl create ns hello

 kubectl apply -n hello -f https://raw.githubusercontent.com/istio/istio/1.1.2/samples/helloworld/helloworld.yaml
```


``` 
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: helloworld
  namespace: hello
spec:
  hosts:
  - "hello.34.76.10.230.xip.io"
  gateways:
  - istio-system/hello-gateway
  http:
  - match:
    - uri:
        exact: /hello
    route:
    - destination:
        host: helloworld
        port:
          number: 5000
---
EOF
```

```
cat <<EOF | kubectl apply -n redirect -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: redirect
spec:
  hosts:
  - "hello.34.76.10.230.xip.io"
  gateways:
  - istio-system/istio-autogenerated-k8s-ingress
  http:
  - route:
    - destination:
        host: redirect
        port:
          number: 80
---
EOF
```