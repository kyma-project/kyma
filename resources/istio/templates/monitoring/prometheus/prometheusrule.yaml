apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    meta.helm.sh/release-name: {{ $.Release.Name | quote }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
  labels:
    app: monitoring
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: envoy-stats
    helm.sh/chart: {{ .Chart.AppVersion }}
    release: monitoring
  name: istio
  namespace: {{ .Release.Namespace }}
spec:
  groups:
  - name: "istio.recording-rules"
    {{- if .Values.prometheus.recordingRules.interval }}
    interval: {{ .Values.prometheus.recordingRules.interval }}
    {{- end }}
    rules:
    - record: "istio_requests_total"
      expr: |
        sum without(instance) (workload:istio_requests_total)
    - record: "istio_request_duration_milliseconds_bucket"
      expr: |
        sum without(instance) (workload:istio_request_duration_milliseconds_bucket)
    - record: "istio_request_bytes_sum"
      expr: |
        sum without(instance) (workload:istio_request_bytes_sum)
    - record: "istio_request_bytes_bucket"
      expr: |
        sum without(instance) (workload:istio_request_bytes_bucket)
    - record: "istio_response_bytes_sum"
      expr: |
        sum without(instance) (workload:istio_response_bytes_sum)
    - record: "istio_response_bytes_bucket"
      expr: |
        sum without(instance) (workload:istio_response_bytes_bucket)
    - record: "istio_tcp_sent_bytes_total"
      expr: |
        sum without(instance) (workload:istio_tcp_sent_bytes_total)
    - record: "istio_tcp_received_bytes_total"
      expr: |
        sum without(instance) (workload:istio_tcp_received_bytes_total)
