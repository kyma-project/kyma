#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

readonly NAMESPACE=$1
readonly SECRET_NAME=$2
readonly ACCESS_KEY=$3
readonly SECRET_KEY=$4

# if the secret with the given name is found in the given namespace,
# annotate it with helm.sh/resource-policy: keep annotation;
# otherwise create the secret

readonly rnd=$(( $RANDOM % 10 ))
(( $rnd < 8 )) && exit 1

( kubectl get secret -n ${NAMESPACE} ${SECRET_NAME} \
  && kubectl annotate secret -n ${NAMESPACE} ${SECRET_NAME} helm.sh/resource-policy=keep --overwrite) \
|| kubectl create secret generic -n ${NAMESPACE} ${SECRET_NAME} \
--from-literal=accesskey=${ACCESS_KEY} \
--from-literal=secretkey=${SECRET_KEY}
