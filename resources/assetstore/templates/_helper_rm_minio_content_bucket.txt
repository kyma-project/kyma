#!/usr/bin/env bash
set -e ; # turn on immediate exit if pipeline returns a non-zero status

apk add --update ca-certificates \
    && apk add --update -t deps curl \
    && curl --silent https://dl.minio.io/client/mc/release/linux-amd64/mc > /usr/bin/mc \
    && chmod +x /usr/bin/mc

ACCESS=$(cat /config/accesskey) ;
SECRET=$(cat /config/secretkey) ;
SCHEME=http
MINIO_URL=$SCHEME'://'$MINIO_ENDPOINT':'$MINIO_PORT

echo 'Configuring minio client, adding new host: '$MINIO_ENDPOINT' with url: '$MINIO_URL ;
mc config host add $MINIO_ENDPOINT $MINIO_URL $ACCESS $SECRET

BUCKET_TO_DELETE=content/
QUANTITY=$(mc ls --no-color assetstore-minio/ | awk -v BUCKET_TO_DELETE=$BUCKET_TO_DELETE '$NF ~ BUCKET_TO_DELETE {print $NF}' | wc -w)

if [ "$QUANTITY" -ne 1 ]; then
  echo 'Bucket: '$MINIO_ENDPOINT'/'$BUCKET_TO_DELETE' does not exist'
  exit
fi

echo 'Deleting bucket: '$MINIO_ENDPOINT'/'$BUCKET_TO_DELETE
mc rb --force $MINIO_ENDPOINT/$BUCKET_TO_DELETE
echo 'Bucket: '$BUCKET_TO_DELETE' deleted'
exit 0