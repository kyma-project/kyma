apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-kyma-patch-config
  namespace: {{ .Release.Namespace }}
  labels:
    app: istio-kyma-patch
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
data:
  istio-egressgateway.deployment.patch.json: |
    [
      {
        "op": "replace",
        "path": "/spec/template/spec/containers/0/args/15",
        "value": "zipkin.kyma-system:9411"
      }
    ]

  istio-ingress.deployment.patch.json: |
    [
      {
        "op": "replace",
        "path": "/spec/template/spec/containers/0/args/15",
        "value": "zipkin.kyma-system:9411"
      }
    ]

  istio-mixer-post-install.job.patch.json: |
    [
      {
        "op": "replace",
        "path": "/metadata/annotations/helm.sh~1hook-delete-policy",
        "value": "hook-succeeded"
      }
    ]


  istio-ingressgateway.deployment.patch.json: |
    [
      {
        "op": "replace",
        "path": "/spec/template/spec/containers/0/args/15",
        "value": "zipkin.kyma-system:9411"
      }
      {{ if .Values.global.isLocalEnv }}
      ,{
        "op": "add",
        "path": "/spec/template/spec/containers/0/ports/0/hostPort",
        "value": 80
      },{
        "op": "add",
        "path": "/spec/template/spec/containers/0/ports/1/hostPort",
        "value": 443
      }
      {{ end }}
      {{ if .Values.global.externalPublicIp }}
      ,{
        "op": "replace",
        "path": "/spec/loadBalancerIP",
        "value": "{{ .Values.global.externalPublicIp }}"
      }
      {{ end }}
    ]

  istio-pilot.deployment.patch.json: |
    [
      {
        "op": "add",
        "path": "/spec/template/spec/containers/0/args",
        "value": ["discovery", "--webhookEndpoint", "http://istio-webhook:5000"]
      }
    ]

  istio-policy.deployment.patch.json: |
    [
      {
        "op": "replace",
        "path": "/spec/template/spec/containers/0/args/4",
        "value": "--trace_zipkin_url=http://zipkin.kyma-system:9411/api/v1/spans"
      }
    ]


  delete: |
    deployment prometheus
    deployment istio-tracing
    deployment servicegraph
    deployment grafana
    job istio-grafana-post-install
    service grafana
    service jaeger-agent
    service jaeger-collector
    service jaeger-query
    service prometheus
    service servicegraph
    service tracing
    service zipkin
    serviceaccount istio-grafana-post-install-account
    serviceaccount prometheus

  required-crds: |
    policies.authentication.istio.io

  istio-ingressgateway-certs.yaml: |
    apiVersion: v1
    data:
      "tls.key": {{ .Values.global.tls.key }}
      "tls.crt": {{ .Values.global.tls.crt }}
    kind: Secret
    metadata:
      name: istio-ingressgateway-certs
      namespace: istio-system
    type: kubernetes.io/tls

  istio-webhook.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: istio-webhook
    data:
      plugin.lua: |
{{ .Files.Get "scripts/webhook.lua" | indent 8  }}
    ---
    apiVersion: extensions/v1beta1
    kind: Deployment
    metadata:
      name: istio-webhook
      namespace: istio-system
    spec:
      replicas: 1
      template:
        metadata:
          labels:
            app: istio-webhook
            version: v1
        spec:
          containers:
          - image: eu.gcr.io/kyma-project/istio-webhook:2.0.0
            name: istio-webhook
            ports:
            - containerPort: 5000
            args:
            - --script
            - /istio-webhook/scripts/webhook.lua
            - --port
            - "5000"
            volumeMounts:
            - name: config-volume
              mountPath: /istio-webhook/scripts
          volumes:
          - name: config-volume
            configMap:
              name: istio-webhook
    ---
    apiVersion: v1
    kind: Service
    metadata:
      annotations:
        "auth.istio.io/5000": NONE
      name: istio-webhook
      namespace: istio-system
      labels:
        app: istio-webhook
    spec:
      ports:
      - name: http
        port: 5000
      selector:
        app: istio-webhook