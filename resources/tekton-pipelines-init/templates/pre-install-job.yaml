---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-install
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tekton-install
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
rules:
  - apiGroups:
      - policy
    resources:
      - podsecuritypolicies
    verbs:
      - get
      - delete
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - get
      - delete
  - apiGroups:
      - caching.internal.knative.dev
    resources:
      - images
    verbs:
      - get
      - delete
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - clusterrolebindings
      - clusterroles
    verbs:
      - get
      - delete
  - apiGroups:
      - ""
    resources:
      - configmaps
      - services
      - serviceaccounts
    verbs:
      - get
      - delete
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tekton-install
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: "before-hook-creation"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-install
subjects:
  - kind: ServiceAccount
    name: tekton-install
    namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: tekton-install
  annotations:
    helm.sh/hook-delete-policy: "before-hook-creation, hook-succeeded"
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "10"
spec:
  backoffLimit: 1
  template:
    metadata:
      name: tekton-install
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: tekton-install
      restartPolicy: Never
      containers:
        - name: job
          image: eu.gcr.io/kyma-project/test-infra/alpine-kubectl:v20190325-ff66a3a
          terminationMessagePolicy: "FallbackToLogsOnError"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              kubectl delete crd \
                builds.build.knative.dev \
                buildtemplates.build.knative.dev \
                clusterbuildtemplates.build.knative.dev \
                --ignore-not-found
              cat <<EOF | kubectl delete --ignore-not-found -f -
              apiVersion: policy/v1beta1
              kind: PodSecurityPolicy
              metadata:
                name: knative-build
              ---
              apiVersion: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              metadata:
                name: knative-build-admin
              ---
              apiVersion: v1
              kind: ServiceAccount
              metadata:
                name: build-controller
                namespace: knative-build
              ---
              apiVersion: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              metadata:
                name: build-controller-admin
              ---
              apiVersion: v1
              kind: Service
              metadata:
                labels:
                  app: build-controller
                name: build-controller
                namespace: knative-build
              ---
              apiVersion: v1
              kind: Service
              metadata:
                labels:
                  role: build-webhook
                name: build-webhook
                namespace: knative-build
              ---
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: config-logging
                namespace: knative-build
              ---
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: build-controller
                namespace: knative-build
              ---
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: build-webhook
                namespace: knative-build
              ---
              EOF

              cat <<EOF | kubectl delete --ignore-not-found -f - || true
              apiVersion: caching.internal.knative.dev/v1alpha1
              kind: Image
              metadata:
                name: creds-init
                namespace: knative-build
              ---
              apiVersion: caching.internal.knative.dev/v1alpha1
              kind: Image
              metadata:
                name: git-init
                namespace: knative-build
              ---
              apiVersion: caching.internal.knative.dev/v1alpha1
              kind: Image
              metadata:
                name: gcs-fetcher
                namespace: knative-build
              ---
              apiVersion: caching.internal.knative.dev/v1alpha1
              kind: Image
              metadata:
                name: nop
                namespace: knative-build
              ---
              EOF
