{{- if .Values.global.ory.hydra.persistence.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}
  annotations:
    helm.sh/hook: "post-install,post-upgrade"
    helm.sh/hook-delete-policy: "before-hook-creation,hook-succeeded"
spec:
  backoffLimit: 1
  template:
    metadata:
      name: {{ .Release.Name }}
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: {{ .Release.Name }}-service-account
      restartPolicy: Never
      volumes:
        - name: db-secret
          secret:
            secretName: {{ include "ory-init.fullname" . }}-hydra-credentials
      containers:
        - name: {{ .Release.Name }}
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          command:
            - /bin/bash
            - -c
            - |
{{.Files.Get "files/prepare-database-dsn-override.sh" | printf "%s" | indent 14}}
          env:
            - name: DB_SECRET_KEY
              {{- if .Values.global.ory.hydra.persistence.secretKey }}
              value: "{{ .Values.global.ory.hydra.persistence.secretKey }}"
              {{- else }}
              value: "postgresql-password"
              {{- end }}
            - name: DB_USER
              {{- if .Values.global.ory.hydra.persistence.user }}
              value: "{{ .Values.global.ory.hydra.persistence.user }}"
              {{- else }}
              value: "hydra"
              {{- end }}
            - name: DB_URL
              {{- if .Values.global.ory.hydra.persistence.dbUrl }}
              value: "{{ .Values.global.ory.hydra.persistence.dbUrl }}"
              {{- else }}
              value: "ory-postgresql.{{ .Release.Namespace }}.svc.cluster.local:5432"
              {{- end }}
            - name: DB_NAME
              {{- if .Values.global.ory.hydra.persistence.dbName }}
              value: "{{ .Values.global.ory.hydra.persistence.dbName }}"
              {{- else }}
              value: "db4hydra"
              {{- end }}
            - name: DB_TYPE
              {{- if .Values.global.ory.hydra.persistence.dbType }}
              value: ".Values.global.ory.hydra.persistence.dbType "
              {{- else }}
              value: "postgres"
              {{- end }}
            - name: OVERRIDES_NAMESPACE
              value: "kyma-installer"
          volumeMounts:
            - name: db-secret
              mountPath: "/etc/database"
              readOnly: true
{{- end }}