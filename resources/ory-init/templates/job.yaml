{{- if .Values.global.ory.hydra.persistence.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  template:
    metadata:
      name: {{ .Release.Name }}
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: {{ .Release.Name }}-service-account
      restartPolicy: Never
      volumes:
        - name: db-secret
          secret:
            secretName: {{ include "ory-init.fullname" . }}-hydra-credentials
      containers:
        - name: {{ .Release.Name }}
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          command:
            - /bin/bash
            - -c
            - |
{{.Files.Get "files/prepare-database-dsn-override.sh" | printf "%s" | indent 14}}
          env:
            - name: DB_SECRET_KEY
              {{- if .Values.global.ory.hydra.persistence.postgresql.enabled }}
              value: "postgresql-password"
              {{- else }}
              value: "{{ .Values.global.ory.hydra.persistence.secretKey }}"
              {{- end }}
            - name: DB_USER
              {{- if .Values.global.ory.hydra.persistence.postgresql.enabled }}
              value: "{{ .Values.global.postgresql.postgresqlUsername }}"
              {{- else }}
              value: "{{ .Values.global.ory.hydra.persistence.user }}"
              {{- end }}
            - name: DB_URL
              {{- if .Values.global.ory.hydra.persistence.postgresql.enabled }}
              value: "ory-postgresql.{{ .Release.Namespace }}.svc.cluster.local:5432"
              {{- else }}
              value: "{{ .Values.global.ory.hydra.persistence.dbUrl }}"
              {{- end }}
            - name: DB_NAME
              {{- if .Values.global.ory.hydra.persistence.postgresql.enabled }}
              value: "{{ .Values.global.postgresql.postgresqlDatabase }}"
              {{- else }}
              value: "{{ .Values.global.ory.hydra.persistence.dbName }}"
            - name: DB_TYPE
              {{- if .Values.global.ory.hydra.persistence.postgresql.enabled }}
              value: "postgres"
              {{- else }}
              value: "{{ .Values.global.ory.hydra.persistence.dbType }}"
              {{- end }}
            - name: OVERRIDES_NAMESPACE
              value: "kyma-installer"
              {{- end }}
          volumeMounts:
            - name: db-secret
              mountPath: "/etc/database"
              readOnly: true
{{- end }}