# NOTE: The Role, ServiceAccount, and RoleBinding are created once during installation and not removed after (or recreated before) each test. This is a limitation of Helm: it can only create a Pod during testing.
# (This applies to Helm 2.7.2.)
apiVersion: "testing.kyma-project.io/v1alpha1"
kind: TestDefinition
metadata:
  name: kubeless-integration
  namespace: {{ .Release.Namespace }}
spec:
  template:
    metadata:
      name: test-{{ template "fullname" . }}
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccount: "test-{{ template "fullname" . }}"
      containers:
        - name: test-{{ template "fullname" . }}
          image: {{ .Values.global.containerRegistry.path }}/{{ .Values.global.kubeless_tests.dir }}kubeless-tests:{{ .Values.global.kubeless_tests.version }}
          env:
          - name: KUBELESS_NAMESPACE
            value: kyma-system
          - name: KUBELESS_CONFIG
            value: {{ template "fullname" . }}-config
          - name: DOMAIN_NAME
            value: {{ .Values.global.ingress.domainName }}
      restartPolicy: Never
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: test-{{ template "fullname" . }}
  labels:
    helm-chart-test: "true"
rules:
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["delete", "get", "list"]
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["create", "delete", "get", "list", "patch"]
  - apiGroups: [""]
    resources: ["services", "services/proxy", "configmaps", "pods/log", "replicationcontrollers"]
    verbs: ["get", "list"]
  - apiGroups: ["kubeless.io"]
    resources: ["functions"]
    verbs: ["create", "delete", "get", "list"]
  - apiGroups: ["apps"]
    resources: ["daemonsets", "deployments", "replicasets", "statefulsets"]
    verbs: ["get", "list"]
  - apiGroups: ["batch"]
    resources: ["cronjobs"]
    verbs: ["get", "list"]
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-{{ template "fullname" . }}
  labels:
    helm-chart-test: "true"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: test-{{ template "fullname" . }}
  labels:
    helm-chart-test: "true"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: test-{{ template "fullname" . }}
subjects:
  - kind: ServiceAccount
    name: test-{{ template "fullname" . }}
    namespace: {{ .Release.Namespace }}