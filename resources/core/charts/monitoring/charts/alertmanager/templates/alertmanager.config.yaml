{{ define "alertmanager.yaml.tpl" }}
global:
  resolve_timeout: 5m
route:
  receiver: 'null'
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 5m
  group_by: ['cluster','pod','job','alertname']
  # All alerts that do not match the following child routes
  # will remain at the root node and be dispatched to 'default-receiver'
  routes:
  - receiver: 'null'
    match:
      alertname: DeadMansSwitch
  {{- if and .Values.global.alertTools.credentials.victorOps }}
  {{- if and (not (eq "" .Values.global.alertTools.credentials.victorOps.apikey)) (not (eq "" .Values.global.alertTools.credentials.victorOps.routingkey))}}
  - receiver: "victorOps"
    continue: true # If continue: is set to false it will stop after the first matching.
    match_re:
      severity: critical
  {{- end }}
  {{- end }}
  {{- if and .Values.global.alertTools.credentials.slack }}
  {{- if and (not (eq "" .Values.global.alertTools.credentials.slack.channel)) (not (eq "" .Values.global.alertTools.credentials.slack.apiurl))}}
  - receiver: "slack"
    continue: true # If continue: is set to false it will stop after the first matching.
    match_re:
      severity: critical
  {{- end }}
  {{- end }}
receivers:
- name: 'null'
{{- if and .Values.global.alertTools.credentials.victorOps }}
{{- if and (not (eq "" .Values.global.alertTools.credentials.victorOps.apikey)) (not (eq "" .Values.global.alertTools.credentials.victorOps.routingkey)) }}
- name: "victorOps"
  victorops_configs:
  - api_key: {{ .Values.global.alertTools.credentials.victorOps.apikey | quote }}
    send_resolved: true
    api_url: https://alert.victorops.com/integrations/generic/20131114/alert/
    routing_key: {{ .Values.global.alertTools.credentials.victorOps.routingkey | quote }}
    state_message: 'Alert: {{`{{ .CommonLabels.alertname }}`}}. Summary:{{`{{ .CommonAnnotations.summary }}`}}. RawData: {{`{{ .CommonLabels }}`}}'
{{- end }}
{{- end }}
{{- if and .Values.global.alertTools.credentials.slack }}
{{- if and (not (eq "" .Values.global.alertTools.credentials.slack.channel)) (not (eq "" .Values.global.alertTools.credentials.slack.apiurl)) }}
- name: "slack"
  slack_configs:
  - channel: {{ .Values.global.alertTools.credentials.slack.channel | quote }}
    send_resolved: true
    api_url: {{ .Values.global.alertTools.credentials.slack.apiurl | quote }}
    icon_emoji: ":ghost:"
    title: '[{{`{{ .Status | toUpper }}`}}{{`{{ if eq .Status "firing" }}`}}:{{`{{ .Alerts.Firing | len }}`}}{{`{{ end }}`}}] Monitoring Event Notification'
    text: "<!channel> \nsummary: {{`{{ .CommonAnnotations.summary }}`}}\ndescription: {{`{{ .CommonAnnotations.description }}`}}"
{{- end }}
{{- end }}
{{ end }}