{{ define "alert-rules-webapps.yaml.tpl"}}
groups:
- name: webapps.rules
  rules:
  - alert: WebAppRateRequestDurationSlow
    expr: sum(irate(istio_request_duration_seconds_bucket{source_workload=~".*"}[5m])) by (source_workload,namespace) * on (source_workload) group_right() label_replace(max(kube_pod_labels{label_kyma_alerts="enabled", label_kyma_component="ui"}) by (label_app,namespace) , "source_workload", "$1", "label_app", "(.*)") > 8
    for: 30m
    labels:
      severity: critical
    annotations:
      description:  "Request duration has slowed down for webapp: {{`{{$labels.source_workload}}`}} in namespace: {{`{{$labels.namespace}}`}}. Response duration is {{`{{$value}}`}} seconds"
      summary: "Request duration has slowed down for webapp: {{`{{$labels.source_workload}}`}}"
  - alert: WebAppHighCountsOfHTTP4xx
    expr: sum(irate(istio_requests_total{destination_workload!="",response_code=~"4.*",destination_app="core-lambdas-ui",connection_security_policy="none"}[5m])) by (destination_workload, destination_workload_namespace)/sum(irate(istio_requests_total{destination_workload!="",destination_app="core-lambdas-ui",connection_security_policy="none"}[5m])) by (destination_workload, destination_workload_namespace) * on (destination_workload) group_right() label_replace(max(kube_pod_labels{label_kyma_alerts="enabled", label_kyma_component="ui"}) by (label_app,namespace) , "destination_workload", "$1", "label_app", "(.*)") * 100 > 30
    for: 30m
    labels:
      severity: critical
    annotations:
      description:  "High counts of HTTP 4xx for service: {{`{{$labels.destination_workload}}`}} in namespace: {{`{{$labels.namespace}}`}}. Percentage of HTTP 4xx codes is {{`{{$value}}`}}%"
      summary: "High counts of HTTP 4xx codes for service: {{`{{$labels.destination_workload}}`}}"
{{ end }}