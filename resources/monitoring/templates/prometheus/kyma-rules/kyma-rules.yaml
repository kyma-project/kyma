apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kyma.rules
  labels:
    app: {{ template "kube-prometheus-stack.name" . }}
{{ include "kube-prometheus-stack.labels" . | indent 4 }}
spec:
  groups:
  - name: pvc-90-percent-full-rule
    rules:
    - alert: PVC90PercentFull
      expr: kubelet_volume_stats_used_bytes{namespace="kube-system",exported_namespace=~"kyma-.*|kube-.*|istio-.*|natss" } / kubelet_volume_stats_capacity_bytes{namespace="kube-system",exported_namespace=~"kyma-.*|kube-.*|istio-.*|natss"} * 100 > 90
      for: 10m
      labels:
        severity: critical
      annotations:
        description:  "PVC {{`{{$labels.exported_namespace}}`}}/{{`{{$labels.persistentvolumeclaim}}`}} is using {{`{{$value}}`}} % of the available volume"
  - name: kube-pod-oomkilled
    rules:
    - alert: KubePodOOMKilled
      expr: sum_over_time(kube_pod_container_status_terminated_reason{reason="OOMKilled"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
      annotations:
        description: Pod {{`{{`}} $labels.namespace {{`}}`}}/{{`{{`}} $labels.pod {{`}}`}} ({{`{{`}} $labels.container {{`}}`}}) is OOMKilled for 5 minutes.
  - name: prometheus-rules
    rules:
    - alert: ScrapeLimitForTargetExceeded
      annotations:
        description: One or more targets in the job monitoring-prometheus-istio-server have scrape limit exceeded
        summary: Scrape limit for one or more targets is exceeded.
      expr: increase(prometheus_target_scrapes_exceeded_sample_limit_total{job="monitoring-prometheus-istio-server"}[1m]) > 0
      for: 1m
      labels:
        severity: critical
