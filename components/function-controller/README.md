# Function Controller

The Function Controller is a Kubernetes controller that enables Kyma to manage Function resources. It uses Kubernetes Jobs and Knative Serving under the hood.

## Prerequisites

The Function Controller requires the following components to be installed:

- [Knative Serving](https://github.com/knative/serving/releases) (v0.12.1)
- [Istio](https://github.com/istio/istio/releases) (v1.4.3)
- [Docker Registry](https://github.com/docker/distribution) (v2.7.1)

## Development

To develop the component, use the formulae declared in the [generic](/common/makefiles/generic-make-go.mk) and [component-specific](./Makefile) Makefiles. To run tests without the Makefile logic, use the `go test ./...` command.

### Environment variables

The Function Controller uses these environment variables:

| Variable                                          | Description                                                                                                                                                                                                               | Default value                                                                                                                                              |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **APP_METRICS_ADDRESS**                           | Address on which controller metrics are exposed                                                                                                                                                                      | `:8080`                                                                                                                                                    |
| **APP_LEADER_ELECTION_ENABLED**                   | Field that enables one instance of the Function Controller to manage the traffic among all instances                                                                                                                                                                                                  | `false`                                                                                                                                                    |
| **APP_LEADER_ELECTION_ID**                        | Name of the ConfigMap that specifies the main instance of the Function Controller that manages the traffic among all instances                                                                                                                                                                  | `serverless-controller-leader-election-helper`                                                                                                             |
| **APP_CONFIG_WATCHER_ENABLE_CONTROLLERS**         | Field that enables Config Watcher controllers that propagate ConfigMaps and Secrets to all Namespaces                                                                                                                                                                                        | `true`                                                                                                                                                     |
| **APP_CONFIG_WATCHER_BASE_NAMESPACE**             | Name of the Namespace with the serverless configuration (such as runtime, Secret and service account for the Docker Registry) propagated to other Namespaces                                                                                                                                                                    | `kyma-system`                                                                                                                                              |
| **APP_CONFIG_WATCHER_EXCLUDED_NAMESPACES**        | List of Namespaces to which serverless configuration is not propagated                                                                                                                                                | `istio-system;knative-eventing;knative-serving;kube-node-lease;kube-public;kube-system;kyma-installer;kyma-integration;kyma-system;natss` |
| **APP_CONFIG_WATCHER_NAMESPACE_REQUEUE_DURATION** | Period of time after which the Function Controller refreshes the status of a Namespace                                                                                                                                           | `1m`                                                                                                                                                       |
| **APP_FUNCTION_IMAGE_PULL_SECRET_NAME**           | Name of the image that contains hashed credentials to the Docker Registry                                                                                                                                    | `serverless-registry-credentials`                                                                                                                 |
| **APP_FUNCTION_IMAGE_PULL_ACCOUNT_NAME**          | Name of the service account that contains credentials to the Docker Registry                                                                                                                                             | `serverless`                                                                                                                                      |
| **APP_FUNCTION_REQUEUE_DURATION**                 | Period of time after which the Function Controller refreshes the status of a Function CR                                                                                                                                          | `1m`                                                                                                                                                       |
| **APP_FUNCTION_BUILD_REQUESTS_CPU**               | Minimum amount of CPU assigned to the Job to build a function image. See [this](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu) document for available values.    | `350m`                                                                                                                                                     |
| **APP_FUNCTION_BUILD_REQUESTS_MEMORY**            | Minimum amount of memory assigned to the Job to build a function image. See [this](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu) document for available values. | `750mi`                                                                                                                                                    |
| **APP_FUNCTION_BUILD_LIMITS_CPU**                 | Maximum amount of CPU assigned to the Job to build a function image. See [this](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu) document for available values.    | `1`                                                                                                                                                        |
| **APP_FUNCTION_BUILD_LIMITS_MEMORY**              | Maximum amount of memory assigned to the Job to build a function image. See [this](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu) document for available values. | `1Gi`                                                                                                                                                      |
| **APP_FUNCTION_BUILD_RUNTIME_CONFIG_MAP_NAME**    | Name of the ConfigMap that contains the runtime definition                                                                                                                                                                   | `dockerfile-nodejs-12`                                                                                                                                     |
| **APP_FUNCTION_BUILD_EXECUTOR_IMAGE**             | Full name of the Kaniko executor image used for building function images and pushing them to the Docker Registry                                                                                                                                                                                | `gcr.io/kaniko-project/executor:v0.17.1`                                                                                                                   |
| **APP_FUNCTION_BUILD_CREDS_INIT_IMAGE**           | Full name of the Tekton image used for building functions. It is run in the Init Container to adjust the Docker credentials to the Kaniko-compatible format.                                                                                                                                                                           | `gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/creds-init:v0.10.1`                                                                               |
| **APP_FUNCTION_DOCKER_ADDRESS**                   | Internal address of the Docker Registry                                                                                                                                | `serverless-docker-registry.kyma-system.svc.cluster.local:5000`                                                                                   |
| **APP_FUNCTION_DOCKER_EXTERNAL_ADDRESS**          | External address of the Docker Registry                                                                | `registry.kyma.local`                                                                                                                                      |
